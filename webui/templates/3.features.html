{% extends "base.html" %}
{% block title %}Features{% endblock %}

{% block head %}
{{ super() }}
<script id="tailwind-config">
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#1337ec",
                    "background-light": "#f6f6f8",
                    "background-dark": "#101322",
                },
                fontFamily: {
                    "display": ["Space Grotesk"]
                },
                borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
            },
        },
    }
</script>

<style>
    [x-cloak] {
        display: none !important;
    }
    .drop-zone {
        border-style: dashed;
    }
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .simulation-accent-border {
        border-color: #FAC638 !important;
    }
    @keyframes upload-indeterminate {
        0% { transform: translateX(-120%); }
        100% { transform: translateX(320%); }
    }
    .upload-indeterminate {
        animation: upload-indeterminate 1.2s linear infinite;
    }
</style>
{% endblock %}

{% block content %}
<script>
    window.__featuresPipelineFiles = {{ pipeline_files | tojson }};

    function featuresPage() {
        return {
            activeTab: 'entry',
            entryChoice: '',
            uploads: {},
            pipelineFiles: window.__featuresPipelineFiles || [],
            selectedPipelinePath: '',
            dataSourceKind: 'new-simulation',
            empiricalSourceMode: 'server-path',
            empiricalFolderPath: '',
            simulationFilePath: '',
            parserInfo: null,
            parserLoading: false,
            parserError: '',
            empiricalFileCount: 0,
            empiricalSampleName: '',
            simulationFileCount: 0,
            simulationSampleName: '',
            parserDataLocator: '',
            parserFsManual: String(1.0 / (0.0625e-3)),
            parserFsSource: '__none__',
            parserSensorNames: '',
            parserChNamesSource: '__autocomplete__',
            parserRecordingType: 'LFP',
            parserRecordingTypeLocator: '',
            parserRecordingTypeSource: '__value__',
            parserSubjectIdLocator: '',
            parserGroupLocator: '',
            parserFsLocator: '',
            parserChNamesLocator: '',
            parserTableLayout: '',
            parserLongTimeCol: '',
            parserLongChannelCol: '',
            parserLongValueCol: '',
            parserEnableEpoching: false,
            parserEpochLengthS: '5.0',
            parserEpochStepS: '5.0',
            parserZscore: false,
            parserEnableAggregate: false,
            parserAggregateOverSelected: ['sensor'],
            parserAggregateMethod: 'sum',
            parserAggregateLabels: '',
            selectedMethod: '',
            dfaAnalysisMode: 'envelope',
            fEIAnalysisMode: 'envelope',
            submitInProgress: false,
            uploadProgress: 0,
            uploadStatusMessage: '',
            uploadBytesLoaded: 0,
            uploadBytesTotal: 0,
            uploadProgressKnown: false,
            uploadWaitTimer: null,
            uploadWaitSeconds: 0,
            submitError: '',
            methods: [
                {
                    key: 'catch22',
                    label: 'Catch22',
                    description: '22 canonical time-series characteristics.',
                    value: 'catch22'
                },
                {
                    key: 'specparam',
                    label: 'Specparam',
                    description: 'Spectral parameterization of neural power spectra.',
                    value: 'specparam'
                },
                {
                    key: 'dfa',
                    label: 'DFA',
                    description: 'Detrended fluctuation analysis.',
                    value: 'dfa'
                },
                {
                    key: 'fEI',
                    label: 'fEI',
                    description: 'Functional excitation-inhibition ratio.',
                    value: 'fEI'
                },
                {
                    key: 'hctsa',
                    label: 'hctsa',
                    description: 'Highly comparative time-series analysis.',
                    value: 'hctsa'
                }
            ],
            isUploaded(id) {
                return this.uploads[id] !== undefined;
            },
            getFileName(id) {
                return this.uploads[id]?.name || '';
            },
            resolvedDataSourceKind() {
                if (this.selectedPipelinePath) return 'pipeline';
                if (this.dataSourceKind === 'new-simulation' && (this.simulationFileCount > 0 || this.isUploaded('data-file'))) return 'new-simulation';
                if (this.dataSourceKind === 'new-empirical' && this.empiricalFileCount > 0) return 'new-empirical';
                if (this.simulationFileCount > 0) return 'new-simulation';
                if (this.isUploaded('data-file')) return 'new-simulation';
                if (this.empiricalFileCount > 0) return 'new-empirical';
                return '';
            },
            activeNewDataMode() {
                return this.dataSourceKind || 'new-simulation';
            },
            hasAnyData() {
                return this.resolvedDataSourceKind() !== '';
            },
            aggregateOverOptions() {
                const base = [
                    'sensor',
                    'epoch',
                    'subject_id',
                    'group',
                    'condition',
                    'species',
                    'recording_type',
                    'source_file',
                ];
                const candidates = Array.isArray(this.parserInfo?.candidate_fields)
                    ? this.parserInfo.candidate_fields.map((field) => String(field))
                    : [];
                const seen = new Set();
                const out = [];
                for (const item of [...base, ...candidates]) {
                    const key = String(item || '').trim();
                    if (!key || seen.has(key)) continue;
                    seen.add(key);
                    out.push(key);
                }
                return out;
            },
            canSubmitFeatures() {
                if (this.submitInProgress) return false;
                const kind = this.resolvedDataSourceKind();
                if (!this.selectedMethod) return false;
                if (!this.parserDataLocator) return false;
                if (this.parserEnableAggregate && (!Array.isArray(this.parserAggregateOverSelected) || this.parserAggregateOverSelected.length === 0)) return false;
                const fsSource = String(this.parserFsSource || '').trim();
                if (!fsSource) return false;
                if (fsSource === '__numeric__' && !String(this.parserFsManual || '').trim()) return false;
                const recSource = String(this.parserRecordingTypeSource || '').trim();
                if (!recSource) return false;
                if (recSource === '__value__' && !String(this.parserRecordingType || '').trim()) return false;
                const chSource = String(this.parserChNamesSource || '').trim();
                if (!chSource) return false;
                if (chSource === '__manual__' && !String(this.parserSensorNames || '').trim()) return false;

                if (kind === 'pipeline') {
                    if (this.parserEnableEpoching && (!this.parserEpochLengthS || !this.parserEpochStepS)) return false;
                    return true;
                }
                if (kind === 'new-simulation') {
                    const hasSimulationPath = String(this.simulationFilePath || '').trim().length > 0 && this.simulationFileCount > 0;
                    if (!this.isUploaded('data-file') && !hasSimulationPath) return false;
                    if (this.parserEnableEpoching && (!this.parserEpochLengthS || !this.parserEpochStepS)) return false;
                    return true;
                }
                if (kind === 'new-empirical') {
                    if (this.empiricalSourceMode === 'server-path') {
                        if (!String(this.empiricalFolderPath || '').trim()) return false;
                    } else if (this.empiricalFileCount <= 0) {
                        return false;
                    }
                    if (this.parserEnableEpoching && (!this.parserEpochLengthS || !this.parserEpochStepS)) return false;
                    return true;
                }
                return false;
            },
            selectedDataDescription() {
                const kind = this.resolvedDataSourceKind();
                if (kind === 'pipeline') {
                    const row = this.pipelineFiles.find((item) => item.path === this.selectedPipelinePath);
                    return row ? row.name : 'Detected pipeline file';
                }
                if (kind === 'new-simulation') {
                    const filePath = String(this.simulationFilePath || '').trim();
                    if (filePath) return this.simulationSampleName || filePath;
                    return this.getFileName('data-file') || 'Uploaded simulation file';
                }
                if (kind === 'new-empirical') {
                    if (this.empiricalSourceMode === 'server-path') {
                        const folder = String(this.empiricalFolderPath || '').trim();
                        if (!folder) return 'Empirical server folder path not set';
                        return `${this.empiricalFileCount || 0} empirical file(s) from ${folder}`;
                    }
                    return `${this.empiricalFileCount} empirical file(s) selected`;
                }
                return '';
            },
            setNewDataMode(kind) {
                this.stopUploadWaitPulse();
                this.submitInProgress = false;
                this.uploadProgress = 0;
                this.uploadStatusMessage = '';
                this.uploadBytesLoaded = 0;
                this.uploadBytesTotal = 0;
                this.uploadProgressKnown = false;
                this.submitError = '';
                this.empiricalSourceMode = 'server-path';
                this.dataSourceKind = kind;
                this.selectedPipelinePath = '';
                if (kind !== 'new-simulation') {
                    delete this.uploads['data-file'];
                    const simInput = document.getElementById('data-file');
                    if (simInput) simInput.value = '';
                    this.simulationFilePath = '';
                    this.simulationFileCount = 0;
                    this.simulationSampleName = '';
                }
                if (kind !== 'new-empirical') {
                    this.empiricalFolderPath = '';
                    this.empiricalFileCount = 0;
                    this.empiricalSampleName = '';
                }
                this.resetParserConfig();
            },
            resetParserConfig() {
                this.parserInfo = null;
                this.parserError = '';
                this.parserDataLocator = '';
                this.parserFsManual = String(1.0 / (0.0625e-3));
                this.parserFsSource = '__none__';
                this.parserSensorNames = '';
                this.parserChNamesSource = '__autocomplete__';
                this.parserRecordingType = 'LFP';
                this.parserRecordingTypeLocator = '';
                this.parserRecordingTypeSource = '__value__';
                this.parserSubjectIdLocator = '';
                this.parserGroupLocator = '';
                this.parserFsLocator = '';
                this.parserChNamesLocator = '';
                this.parserTableLayout = '';
                this.parserLongTimeCol = '';
                this.parserLongChannelCol = '';
                this.parserLongValueCol = '';
                this.parserEnableEpoching = false;
                this.parserEpochLengthS = '5.0';
                this.parserEpochStepS = '5.0';
                this.parserZscore = false;
                this.parserEnableAggregate = false;
                this.parserAggregateOverSelected = ['sensor'];
                this.parserAggregateMethod = 'sum';
                this.parserAggregateLabels = '';
            },
            selectPipeline(path) {
                this.stopUploadWaitPulse();
                this.submitInProgress = false;
                this.uploadProgress = 0;
                this.uploadStatusMessage = '';
                this.uploadBytesLoaded = 0;
                this.uploadBytesTotal = 0;
                this.uploadProgressKnown = false;
                this.submitError = '';
                this.empiricalSourceMode = 'server-path';
                this.empiricalFolderPath = '';
                this.simulationFilePath = '';
                this.selectedPipelinePath = path;
                this.dataSourceKind = 'pipeline';
                delete this.uploads['data-file'];
                this.simulationFileCount = 0;
                this.simulationSampleName = '';
                this.empiricalFileCount = 0;
                this.empiricalSampleName = '';
                const simInput = document.getElementById('data-file');
                if (simInput) simInput.value = '';
                this.resetParserConfig();
                this.inspectParserSource(path, null);
            },
            onFileSelected(file, inputId) {
                if (inputId !== 'data-file') return;
                this.stopUploadWaitPulse();
                this.submitInProgress = false;
                this.uploadProgress = 0;
                this.uploadStatusMessage = '';
                this.uploadBytesLoaded = 0;
                this.uploadBytesTotal = 0;
                this.uploadProgressKnown = false;
                this.submitError = '';
                this.empiricalSourceMode = 'server-path';
                this.empiricalFolderPath = '';
                this.simulationFilePath = '';
                this.dataSourceKind = 'new-simulation';
                this.selectedPipelinePath = '';
                this.simulationFileCount = 0;
                this.simulationSampleName = '';
                this.empiricalFileCount = 0;
                this.empiricalSampleName = '';
                this.resetParserConfig();
                this.inspectParserSource('', file);
            },
            async pickSimulationFile() {
                this.submitError = '';
                this.parserError = '';
                try {
                    const formData = new FormData();
                    formData.append('mode', 'file');
                    const response = await fetch('{{ url_for('features_select_folder') }}', { method: 'POST', body: formData });
                    const payload = await response.json();
                    if (!response.ok) throw new Error(payload.error || 'File selection cancelled.');
                    this.simulationFilePath = payload.path || '';
                    if (!this.simulationFilePath) {
                        throw new Error('No file path returned by selector.');
                    }
                    await this.inspectSimulationFilePath();
                } catch (error) {
                    this.parserError = error.message || 'Failed to select file.';
                }
            },
            async inspectSimulationFilePath() {
                const filePath = String(this.simulationFilePath || '').trim();
                this.submitError = '';
                this.parserError = '';
                if (!filePath) {
                    this.parserError = 'Provide a valid simulation output file path.';
                    this.simulationFileCount = 0;
                    this.simulationSampleName = '';
                    this.parserInfo = null;
                    return;
                }
                this.parserLoading = true;
                this.parserInfo = null;
                try {
                    const formData = new FormData();
                    formData.append('simulation_file_path', filePath);
                    const response = await fetch('{{ url_for('features_parser_inspect') }}', {
                        method: 'POST',
                        body: formData,
                    });
                    const payload = await response.json();
                    if (!response.ok) throw new Error(payload.error || 'Failed to inspect simulation file.');
                    this.parserInfo = payload;
                    this.applyParserDefaults(payload);
                    this.simulationFileCount = 1;
                    this.simulationSampleName = payload.source_name || '';
                    this.dataSourceKind = 'new-simulation';
                    this.selectedPipelinePath = '';
                    delete this.uploads['data-file'];
                    const simInput = document.getElementById('data-file');
                    if (simInput) simInput.value = '';
                } catch (error) {
                    this.parserError = error.message || 'Failed to inspect simulation file.';
                    this.simulationFileCount = 0;
                    this.simulationSampleName = '';
                } finally {
                    this.parserLoading = false;
                }
            },
            async pickEmpiricalFolder() {
                this.submitError = '';
                this.parserError = '';
                try {
                    const response = await fetch('{{ url_for('features_select_folder') }}', { method: 'POST' });
                    const payload = await response.json();
                    if (!response.ok) throw new Error(payload.error || 'Folder selection cancelled.');
                    this.empiricalFolderPath = payload.path || '';
                    if (!this.empiricalFolderPath) {
                        throw new Error('No folder path returned by selector.');
                    }
                    await this.inspectEmpiricalFolderPath();
                } catch (error) {
                    this.parserError = error.message || 'Failed to select folder.';
                }
            },
            async inspectEmpiricalFolderPath() {
                const folder = String(this.empiricalFolderPath || '').trim();
                this.submitError = '';
                this.parserError = '';
                if (!folder) {
                    this.parserError = 'Provide a valid empirical folder path.';
                    this.empiricalFileCount = 0;
                    this.empiricalSampleName = '';
                    this.parserInfo = null;
                    return;
                }
                this.parserLoading = true;
                this.parserInfo = null;
                try {
                    const formData = new FormData();
                    formData.append('empirical_folder_path', folder);
                    const response = await fetch('{{ url_for('features_parser_inspect') }}', {
                        method: 'POST',
                        body: formData,
                    });
                    const payload = await response.json();
                    if (!response.ok) throw new Error(payload.error || 'Failed to inspect empirical folder.');
                    this.parserInfo = payload;
                    this.applyParserDefaults(payload);
                    this.empiricalFileCount = Number(payload.folder_file_count || 0);
                    this.empiricalSampleName = payload.source_name || '';
                    this.dataSourceKind = 'new-empirical';
                } catch (error) {
                    this.parserError = error.message || 'Failed to inspect empirical folder.';
                    this.empiricalFileCount = 0;
                    this.empiricalSampleName = '';
                } finally {
                    this.parserLoading = false;
                }
            },
            applyParserDefaults(payload) {
                const defaults = payload?.defaults || {};
                if (!this.parserDataLocator) this.parserDataLocator = defaults.data || '';
                if (!this.parserFsLocator) this.parserFsLocator = defaults.fs || '';
                if (!this.parserRecordingTypeLocator) this.parserRecordingTypeLocator = defaults.recording_type || '';
                if (!this.parserSubjectIdLocator) this.parserSubjectIdLocator = defaults.subject_id || '';
                if (!this.parserGroupLocator) this.parserGroupLocator = defaults.group || '';
                if (!this.parserChNamesLocator) this.parserChNamesLocator = defaults.ch_names || '';
                const validAggregate = new Set(this.aggregateOverOptions());
                this.parserAggregateOverSelected = (this.parserAggregateOverSelected || []).filter((dim) => validAggregate.has(dim));
                if (this.parserAggregateOverSelected.length === 0) this.parserAggregateOverSelected = ['sensor'];

                if (String(this.parserFsLocator || '').trim()) {
                    this.parserFsSource = this.parserFsLocator;
                    this.parserFsManual = '';
                } else if (
                    payload?.fs_hint_hz !== null &&
                    payload?.fs_hint_hz !== undefined &&
                    Number.isFinite(Number(payload.fs_hint_hz)) &&
                    Number(payload.fs_hint_hz) > 0
                ) {
                    this.parserFsSource = '__numeric__';
                    this.parserFsManual = String(Number(payload.fs_hint_hz));
                    this.parserFsLocator = '';
                } else {
                    this.parserFsSource = '__none__';
                    this.parserFsManual = '';
                    this.parserFsLocator = '';
                }

                if (String(this.parserRecordingTypeLocator || '').trim()) {
                    this.parserRecordingTypeSource = this.parserRecordingTypeLocator;
                    this.parserRecordingType = '';
                } else {
                    this.parserRecordingTypeSource = '__value__';
                    if (!String(this.parserRecordingType || '').trim()) this.parserRecordingType = 'LFP';
                    this.parserRecordingTypeLocator = '';
                }

                if (String(this.parserChNamesLocator || '').trim()) {
                    this.parserChNamesSource = this.parserChNamesLocator;
                    this.parserSensorNames = '';
                } else {
                    this.parserChNamesSource = '__autocomplete__';
                    this.parserChNamesLocator = '';
                }
            },
            onPipelineFsSourceChange() {
                const source = String(this.parserFsSource || '').trim();
                if (source === '__numeric__') {
                    this.parserFsLocator = '';
                    return;
                }
                if (source === '__none__') {
                    this.parserFsLocator = '';
                    this.parserFsManual = '';
                    return;
                }
                this.parserFsLocator = source;
                this.parserFsManual = '';
            },
            onPipelineRecordingTypeSourceChange() {
                const source = String(this.parserRecordingTypeSource || '').trim();
                if (source === '__value__') {
                    this.parserRecordingTypeLocator = '';
                    if (!String(this.parserRecordingType || '').trim()) this.parserRecordingType = 'LFP';
                    return;
                }
                if (source === '__none__') {
                    this.parserRecordingTypeLocator = '';
                    this.parserRecordingType = '';
                    return;
                }
                this.parserRecordingTypeLocator = source;
                this.parserRecordingType = '';
            },
            onParserChNamesSourceChange() {
                const source = String(this.parserChNamesSource || '').trim();
                if (source === '__manual__') {
                    this.parserChNamesLocator = '';
                    return;
                }
                if (source === '__autocomplete__') {
                    this.parserChNamesLocator = '';
                    this.parserSensorNames = '';
                    return;
                }
                this.parserChNamesLocator = source;
                this.parserSensorNames = '';
            },
            async inspectParserSource(existingPath, file) {
                this.parserLoading = true;
                this.parserError = '';
                this.parserInfo = null;
                const formData = new FormData();
                if (existingPath) formData.append('existing_data_path', existingPath);
                if (file) formData.append('file', file);
                try {
                    const response = await fetch('{{ url_for('features_parser_inspect') }}', {
                        method: 'POST',
                        body: formData,
                    });
                    const payload = await response.json();
                    if (!response.ok) throw new Error(payload.error || 'Failed to inspect data source.');
                    this.parserInfo = payload;
                    this.applyParserDefaults(payload);
                } catch (error) {
                    this.parserError = error.message || 'Failed to inspect data source.';
                } finally {
                    this.parserLoading = false;
                }
            },
            hasUploadPayload() {
                const kind = this.resolvedDataSourceKind();
                if (kind === 'new-simulation') {
                    const simInput = document.getElementById('data-file');
                    return !!(simInput && simInput.files && simInput.files.length > 0);
                }
                if (kind === 'new-empirical') {
                    return false;
                }
                return false;
            },
            formatBytes(bytes) {
                const value = Number(bytes);
                if (!Number.isFinite(value) || value <= 0) return '0 B';
                const units = ['B', 'KB', 'MB', 'GB'];
                let current = value;
                let unit = 0;
                while (current >= 1024 && unit < units.length - 1) {
                    current /= 1024;
                    unit += 1;
                }
                const decimals = current >= 10 || unit === 0 ? 0 : 1;
                return `${current.toFixed(decimals)} ${units[unit]}`;
            },
            stopUploadWaitPulse() {
                if (this.uploadWaitTimer) {
                    clearInterval(this.uploadWaitTimer);
                    this.uploadWaitTimer = null;
                }
                this.uploadWaitSeconds = 0;
            },
            submitComputeFeatures(event) {
                const form = event.target;
                if (this.submitInProgress) return;

                this.stopUploadWaitPulse();
                this.submitError = '';
                this.uploadProgress = 0;
                this.uploadBytesLoaded = 0;
                this.uploadBytesTotal = 0;
                this.uploadProgressKnown = false;
                const uploadRequired = this.hasUploadPayload();

                this.submitInProgress = true;
                this.uploadStatusMessage = uploadRequired ? 'Uploading files...' : 'Submitting configuration...';
                this.uploadProgress = 0;

                const xhr = new XMLHttpRequest();
                xhr.open('POST', form.action, true);

                const startServerIngestPulse = () => {
                    if (!this.submitInProgress) return;
                    if (this.uploadWaitTimer) return;
                    let tick = 0;
                    this.uploadWaitSeconds = 0;
                    this.uploadProgress = Math.max(this.uploadProgress, 95);
                    this.uploadStatusMessage = 'Server ingesting uploaded files (0s)';
                    this.uploadWaitTimer = setInterval(() => {
                        if (!this.submitInProgress) {
                            this.stopUploadWaitPulse();
                            return;
                        }
                        this.uploadWaitSeconds += 1;
                        tick = (tick + 1) % 4;
                        this.uploadStatusMessage = `Server ingesting uploaded files (${this.uploadWaitSeconds}s)${'.'.repeat(tick)}`;
                        if (this.uploadProgress < 99) this.uploadProgress += 1;
                    }, 1000);
                };

                xhr.upload.onprogress = (evt) => {
                    if (evt.lengthComputable && evt.total > 0) {
                        this.stopUploadWaitPulse();
                        this.uploadProgressKnown = true;
                        this.uploadBytesLoaded = evt.loaded;
                        this.uploadBytesTotal = evt.total;
                        const pct = Math.round((evt.loaded / evt.total) * 95);
                        this.uploadProgress = Math.max(0, Math.min(95, pct));
                        if (evt.loaded >= evt.total) {
                            this.uploadStatusMessage = 'Upload complete. Waiting for server response...';
                            startServerIngestPulse();
                        } else {
                            this.uploadStatusMessage = `Uploading files... ${this.uploadProgress}%`;
                        }
                    } else {
                        this.uploadStatusMessage = 'Uploading files...';
                    }
                };
                xhr.upload.onload = () => {
                    this.uploadProgressKnown = true;
                    this.uploadProgress = Math.max(this.uploadProgress, 95);
                    this.uploadStatusMessage = 'Upload complete. Preparing data...';
                    startServerIngestPulse();
                };
                xhr.upload.onloadend = () => {
                    if (this.submitInProgress) {
                        this.uploadProgressKnown = true;
                        this.uploadProgress = Math.max(this.uploadProgress, 95);
                        this.uploadStatusMessage = 'Upload complete. Waiting for server response...';
                        startServerIngestPulse();
                    }
                };
                xhr.onreadystatechange = () => {
                    if (xhr.readyState >= 2 && this.submitInProgress) {
                        // Server started sending response headers/body: upload has finished.
                        this.stopUploadWaitPulse();
                        this.uploadProgressKnown = true;
                        this.uploadProgress = 100;
                        if (!this.uploadStatusMessage.startsWith('Upload complete')) {
                            this.uploadStatusMessage = 'Upload complete. Preparing data...';
                        }
                    }
                };

                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 400) {
                        this.stopUploadWaitPulse();
                        this.uploadProgressKnown = true;
                        this.uploadProgress = 100;
                        this.uploadStatusMessage = 'Upload complete. Starting computation...';
                        const redirectTarget = xhr.responseURL || form.action;
                        window.location.assign(redirectTarget);
                        return;
                    }
                    this.stopUploadWaitPulse();
                    this.submitInProgress = false;
                    this.submitError = `Upload failed (HTTP ${xhr.status}).`;
                };

                xhr.onerror = () => {
                    this.stopUploadWaitPulse();
                    this.submitInProgress = false;
                    this.submitError = 'Upload failed due to a network error.';
                };

                xhr.onabort = () => {
                    this.stopUploadWaitPulse();
                    this.submitInProgress = false;
                    this.submitError = 'Upload was cancelled.';
                };

                try {
                    const formData = new FormData(form);
                    xhr.send(formData);
                } catch (_err) {
                    this.stopUploadWaitPulse();
                    this.submitInProgress = false;
                    this.submitError = 'Unable to start file upload.';
                }
            },
            parserDebugCode() {
                if (!this.hasAnyData()) {
                    return '# Select a data source to preview EphysDatasetParser configuration.';
                }

                const kind = this.resolvedDataSourceKind();
                const dataLocator = this.parserDataLocator || 'REQUIRED_DATA_LOCATOR';
                const epochEnabled = !!this.parserEnableEpoching;
                const epochLength = this.parserEpochLengthS || '5.0';
                const epochStep = this.parserEpochStepS || '5.0';
                const chSource = String(this.parserChNamesSource || '').trim();
                let chNamesExpr = 'None';
                if (chSource === '__manual__') {
                    const sensors = (this.parserSensorNames || '')
                        .split(',')
                        .map((item) => item.trim())
                        .filter((item) => item.length > 0);
                    chNamesExpr = sensors.length > 0
                        ? `[${sensors.map((s) => `'${s}'`).join(', ')}]`
                        : '[]';
                } else if (chSource === '__autocomplete__') {
                    chNamesExpr = `[f"ch{i}" for i in range(data.${dataLocator}.shape[0])]`;
                } else if (chSource) {
                    chNamesExpr = `'${chSource}'`;
                }

                if (kind === 'pipeline' || kind === 'new-simulation') {
                    const fsSource = String(this.parserFsSource || '').trim();
                    let fsValue = 'None';
                    if (fsSource === '__numeric__') {
                        fsValue = this.parserFsManual || 'REQUIRED_FS';
                    } else if (fsSource && fsSource !== '__none__') {
                        fsValue = `'${fsSource}'`;
                    }
                    const recSource = String(this.parserRecordingTypeSource || '').trim();
                    let recordingTypeValue = 'None';
                    if (recSource === '__value__') {
                        recordingTypeValue = `'${(this.parserRecordingType || 'LFP')}'`;
                    } else if (recSource && recSource !== '__none__') {
                        recordingTypeValue = `'${recSource}'`;
                    }
                    const lines = [
                        'ParseConfig(',
                        '    fields=CanonicalFields(',
                        `        data='${dataLocator}',`,
                        `        fs=${fsValue},`,
                        `        ch_names=${chNamesExpr},`,
                        '        metadata={',
                        `            'subject_id': 0,`,
                        `            'group': 'simulation',`,
                        `            'species': 'simulated',`,
                        `            'condition': 'simulation_pipeline',`,
                        `            'recording_type': ${recordingTypeValue},`,
                        '        },',
                        '    ),',
                    ];
                    if (epochEnabled) {
                        lines.push(`    epoch_length_s=${epochLength},`);
                        lines.push(`    epoch_step_s=${epochStep},`);
                    }
                    lines.push(`    zscore=${this.parserZscore ? 'True' : 'False'},`);
                    if (this.parserEnableAggregate) {
                        const aggDims = (this.parserAggregateOverSelected || [])
                            .map((item) => String(item || '').trim())
                            .filter((item) => item.length > 0);
                        if (aggDims.length > 0) {
                            lines.push(`    aggregate_over=(${aggDims.map((d) => `'${d}'`).join(', ')}${aggDims.length === 1 ? ',' : ''}),`);
                            lines.push(`    aggregate_method='${this.parserAggregateMethod || 'sum'}',`);
                            if ((this.parserAggregateLabels || '').trim()) {
                                lines.push(`    aggregate_labels=${this.parserAggregateLabels},`);
                            }
                        }
                    }
                    lines.push(')');
                    return lines.join('\n');
                }

                const fsSource = String(this.parserFsSource || '').trim();
                let fsValue = 'None';
                if (fsSource === '__numeric__') {
                    fsValue = this.parserFsManual || 'REQUIRED_FS';
                } else if (fsSource && fsSource !== '__none__') {
                    fsValue = `'${fsSource}'`;
                }
                const recSource = String(this.parserRecordingTypeSource || '').trim();
                let recordingTypeValue = 'None';
                if (recSource === '__value__') {
                    recordingTypeValue = `'${(this.parserRecordingType || 'LFP')}'`;
                } else if (recSource && recSource !== '__none__') {
                    recordingTypeValue = `'${recSource}'`;
                }
                const subjectIdLocator = String(this.parserSubjectIdLocator || '').trim();
                const subjectIdValue = kind === 'new-empirical' && subjectIdLocator
                    ? (subjectIdLocator === '__file_id__' ? `'file_ID'` : `'${subjectIdLocator}'`)
                    : 'None';
                const groupValue = kind === 'new-empirical' && String(this.parserGroupLocator || '').trim()
                    ? `'${String(this.parserGroupLocator).trim()}'`
                    : 'None';
                const zscoreFlag = this.parserZscore ? 'True' : 'False';
                const lines = [
                    'ParseConfig(',
                    '    fields=CanonicalFields(',
                    `        data='${dataLocator}',`,
                    `        fs=${fsValue},`,
                    `        ch_names=${chNamesExpr},`,
                ];
                const metadataEntries = [];
                if (recordingTypeValue !== 'None') metadataEntries.push(`            'recording_type': ${recordingTypeValue},`);
                if (subjectIdValue !== 'None') metadataEntries.push(`            'subject_id': ${subjectIdValue},`);
                if (groupValue !== 'None') metadataEntries.push(`            'group': ${groupValue},`);
                if (metadataEntries.length > 0) {
                    lines.push('        metadata={');
                    lines.push(...metadataEntries);
                    lines.push('        },');
                }
                lines.push('    ),');
                if (epochEnabled) {
                    lines.push(`    epoch_length_s=${epochLength},`);
                    lines.push(`    epoch_step_s=${epochStep},`);
                }
                lines.push(`    zscore=${zscoreFlag},`);
                if (this.parserEnableAggregate) {
                    const aggDims = (this.parserAggregateOverSelected || [])
                        .map((item) => String(item || '').trim())
                        .filter((item) => item.length > 0);
                    if (aggDims.length > 0) {
                        lines.push(`    aggregate_over=(${aggDims.map((d) => `'${d}'`).join(', ')}${aggDims.length === 1 ? ',' : ''}),`);
                        lines.push(`    aggregate_method='${this.parserAggregateMethod || 'sum'}',`);
                        if ((this.parserAggregateLabels || '').trim()) {
                            lines.push(`    aggregate_labels=${this.parserAggregateLabels},`);
                        }
                    }
                }
                lines.push(')');
                return lines.join('\n');
            },
            chooseEntry(choice) {
                this.stopUploadWaitPulse();
                this.submitInProgress = false;
                this.uploadProgress = 0;
                this.uploadStatusMessage = '';
                this.uploadBytesLoaded = 0;
                this.uploadBytesTotal = 0;
                this.uploadProgressKnown = false;
                this.submitError = '';
                this.entryChoice = choice;
                if (choice === 'compute') {
                    this.activeTab = 'load-data';
                    return;
                }
                if (choice === 'load') {
                    this.activeTab = 'load-precomputed';
                    return;
                }
                this.activeTab = 'entry';
            },
        };
    }
</script>

<div x-data="featuresPage()">
    <div :class="activeTab === 'load-precomputed' ? 'w-full' : 'max-w-5xl mx-auto'">
        <div x-show="activeTab !== 'load-precomputed'" x-cloak class="pb-8">
            <h1 class="text-[#34495E] dark:text-white text-4xl font-black leading-tight tracking-[-0.033em] min-w-72">
                Module Configuration: Features
            </h1>
        </div>

        <div x-show="entryChoice !== '' && activeTab !== 'load-precomputed'" x-cloak class="border-b border-gray-200 dark:border-[#323b67]">
            <nav aria-label="Tabs" class="-mb-px flex space-x-6">
                <button x-show="entryChoice === 'load'" x-cloak @click="activeTab = 'load-precomputed'"
                    :class="{ 'border-[#FAC638] text-[#FAC638]': activeTab === 'load-precomputed', 'border-transparent text-gray-500 dark:text-white/70 hover:text-gray-700 dark:hover:text-white': activeTab !== 'load-precomputed' }"
                    class="shrink-0 border-b-2 px-1 pb-4 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-500 transition-colors">
                    Load features
                </button>
                <button x-show="entryChoice === 'compute'" x-cloak @click="activeTab = 'load-data'"
                    :class="{ 'border-primary text-primary': activeTab === 'load-data', 'border-transparent text-gray-500 dark:text-white/70 hover:text-gray-700 dark:hover:text-white': activeTab !== 'load-data' }"
                    class="shrink-0 border-b-2 px-1 pb-4 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-500 transition-colors">
                    Load data
                </button>
                <button x-show="entryChoice === 'compute'" x-cloak @click="activeTab = 'select-method'"
                    :class="{ 'border-primary text-primary': activeTab === 'select-method', 'border-transparent text-gray-500 dark:text-white/70 hover:text-gray-700 dark:hover:text-white': activeTab !== 'select-method' }"
                    class="shrink-0 border-b-2 px-1 pb-4 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-500 transition-colors">
                    Select Method
                </button>
                <button x-show="entryChoice === 'compute'" x-cloak @click="activeTab = 'configure-method'"
                    :class="{ 'border-primary text-primary': activeTab === 'configure-method', 'border-transparent text-gray-500 dark:text-white/70 hover:text-gray-700 dark:hover:text-white': activeTab !== 'configure-method' }"
                    class="shrink-0 border-b-2 px-1 pb-4 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-500 transition-colors">
                    Configure method
                </button>
            </nav>
        </div>

        <div :class="activeTab === 'load-precomputed' ? '' : 'pt-8'">
            <div x-show="activeTab === 'entry'" x-cloak>
                <div class="flex flex-col gap-3 text-center mb-6">
                    <p class="text-slate-500 dark:text-[#929bc9] text-lg font-normal leading-normal max-w-2xl mx-auto">
                        Select how you would like to proceed with features.
                        You can load existing features or compute new ones.
                    </p>
                </div>
                <div class="flex flex-wrap items-center justify-center gap-8 w-full">
                    <button type="button" @click="chooseEntry('load')"
                        class="flex flex-col items-center justify-center gap-6 p-10 bg-white dark:bg-[#111422] border-2 border-slate-200 dark:border-slate-800 rounded-2xl hover:border-primary dark:hover:border-primary transition-all duration-200 w-full max-w-[320px] aspect-square group shadow-sm">
                        <div class="p-5 rounded-full bg-slate-50 dark:bg-slate-800 group-hover:bg-primary/10 transition-colors">
                            <span class="material-symbols-outlined text-4xl text-slate-600 dark:text-slate-300 group-hover:text-primary">upload_file</span>
                        </div>
                        <span class="text-2xl font-bold text-slate-800 dark:text-white text-center">Load data</span>
                    </button>
                    <button type="button" @click="chooseEntry('compute')"
                        class="flex flex-col items-center justify-center gap-6 p-10 bg-white dark:bg-[#111422] border-2 border-slate-200 dark:border-slate-800 rounded-2xl hover:border-primary dark:hover:border-primary transition-all duration-200 w-full max-w-[320px] aspect-square group shadow-sm">
                        <div class="p-5 rounded-full bg-slate-50 dark:bg-slate-800 group-hover:bg-primary/10 transition-colors">
                            <span class="material-symbols-outlined text-4xl text-slate-600 dark:text-slate-300 group-hover:text-primary">add_circle</span>
                        </div>
                        <span class="text-2xl font-bold text-slate-800 dark:text-white text-center">Compute new features</span>
                    </button>
                </div>
            </div>

            <div x-show="activeTab === 'load-precomputed'" x-cloak class="flex h-full">
                <main class="w-full lg:w-3/5 xl:w-2/3 h-full flex flex-col overflow-y-auto hide-scrollbar">
                    <div class="max-w-4xl w-full mx-auto flex flex-col h-full">
                        <div class="mb-10">
                            <h1 class="text-4xl font-black leading-tight tracking-tight mb-2">Features Configuration: Load Data</h1>
                            <p class="text-slate-500 dark:text-slate-400 text-lg">Select and upload your precomputed features files.</p>
                        </div>

                        <div class="flex flex-col gap-6 flex-grow mb-12">
                            <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col gap-4">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-bold flex items-center gap-2">
                                        <span class="material-symbols-outlined text-[#FAC638]">analytics</span>
                                        Load precomputed features files
                                    </h3>
                                    <button class="text-xs font-semibold text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors">
                                        <span class="material-symbols-outlined text-sm">delete</span> Clear
                                    </button>
                                </div>

                                <form id="featuresUploadForm" action="{{ url_for('features_load_precomputed') }}" method="POST" enctype="multipart/form-data">
                                    <input type="file" id="featuresFileInput" name="precomputed_features_file" class="hidden" accept=".pkl,.pickle" />
                                    <div id="featuresDropZone" onclick="document.getElementById('featuresFileInput').click()"
                                        class="drop-zone flex-1 flex flex-col items-center justify-center py-10 px-6 border-2 border-slate-200 dark:border-slate-800 rounded-xl hover:border-[#FAC638]/50 hover:bg-[#FAC638]/5 dark:hover:bg-[#FAC638]/5 transition-all cursor-pointer group">
                                        <span class="material-symbols-outlined text-4xl text-slate-300 group-hover:text-[#FAC638] mb-3">upload_file</span>
                                        <p class="text-sm font-medium text-slate-600 dark:text-slate-400 text-center">Drag and drop features files or click to browse</p>
                                        <div id="selectedFeaturesFiles" class="mt-4 text-xs text-slate-500 dark:text-slate-400 hidden">
                                            <span class="block font-semibold text-slate-600 dark:text-slate-300">Selected files</span>
                                            <div id="selectedFeaturesFilesList" class="mt-2"></div>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="mt-8 flex justify-end">
                                {% if has_features_data %}
                                <a href="{{url_for('inference')}}"
                                    class="bg-[#FAC638] text-slate-900 px-10 py-3 rounded-lg font-bold text-lg hover:brightness-105 transition-all shadow-md">
                                    Continue to Inference
                                </a>
                                {% else %}
                                <span class="bg-slate-200 text-slate-500 px-10 py-3 rounded-lg font-bold text-lg cursor-not-allowed select-none">
                                    Continue to Inference
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mt-auto pt-6 flex flex-wrap gap-4 border-t border-slate-200 dark:border-slate-800">
                            <a href="{{url_for('dashboard')}}" class="flex items-center gap-2 h-12 px-6 rounded-lg bg-white dark:bg-slate-900 text-slate-800 dark:text-white text-sm font-bold border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                <span class="material-symbols-outlined text-lg">dashboard</span>
                                Back to the dashboard
                            </a>
                            <button type="button" @click="chooseEntry('entry')" class="flex items-center gap-2 h-12 px-6 rounded-lg bg-white dark:bg-slate-900 text-slate-800 dark:text-white text-sm font-bold border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                <span class="material-symbols-outlined text-lg">arrow_back</span>
                                Back to features options
                            </button>
                        </div>
                    </div>
                </main>

                <aside class="lg:flex w-2/5 xl:w-1/3 bg-white dark:bg-slate-900/50 border-l border-slate-200 dark:border-slate-800 flex-col overflow-y-auto">
                    <div class="p-8 xl:p-12 space-y-10">
                        <div>
                            <h4 class="text-xs font-bold uppercase tracking-widest text-slate-400 mb-6">Upload Status</h4>
                            <div class="bg-slate-100 dark:bg-slate-800 rounded-xl p-6 border border-slate-200 dark:border-slate-700">
                                <div class="flex items-center gap-4">
                                    <div class="relative flex">
                                        {% if has_features_data %}
                                        <span class="material-symbols-outlined text-green-500 text-3xl">check_circle</span>
                                        {% else %}
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#FAC638] opacity-20"></span>
                                        <span class="material-symbols-outlined text-[#FAC638] text-3xl">hourglass_empty</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        {% if has_features_data %}
                                        <p class="text-sm font-bold text-green-600 dark:text-green-500">Status: Files detected</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Features files are ready.</p>
                                        <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">
                                            {% for filename in features_data_files %}
                                            <span class="block">{{ filename }}</span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        <p class="text-sm font-bold">Status: Awaiting files</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Please select files to continue</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <h4 class="text-xs font-bold uppercase tracking-widest text-slate-400">Formatting Tips</h4>
                            <div class="space-y-4">
                                <div class="flex gap-4">
                                    <span class="material-symbols-outlined text-[#FAC638] shrink-0">info</span>
                                    <div>
                                        <h5 class="text-sm font-bold mb-1">Supported Formats</h5>
                                        <p class="text-sm text-slate-500 dark:text-slate-400">Ensure your data is saved in .pkl or .pickle.</p>
                                    </div>
                                </div>
                                <div class="flex gap-4">
                                    <span class="material-symbols-outlined text-[#FAC638] shrink-0">grid_on</span>
                                    <div>
                                        <h5 class="text-sm font-bold mb-1">Data Structure</h5>
                                        <p class="text-sm text-slate-500 dark:text-slate-400">Precomputed features dataframes must contain a <code>Features</code> column.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-10 border-t border-slate-200 dark:border-slate-800 text-xs text-slate-400 leading-relaxed">
                            <p>Once the files are successfully uploaded and validated, the inference module is ready for the next step.</p>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <form x-show="entryChoice === 'compute'" x-cloak action="{{ url_for('start_computation_redirect', computation_type='features')}}" method="POST" enctype="multipart/form-data" @submit.prevent="submitComputeFeatures($event)">
            <div class="pt-8">
                <div x-show="activeTab === 'load-data'" x-cloak>
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-[#34495E] dark:text-white">What data do you want to work with?</h2>
                    </div>

                    <input type="hidden" name="data_source_kind" :value="resolvedDataSourceKind()">
                    <input type="hidden" name="existing_data_path" :value="selectedPipelinePath">
                    <input type="hidden" name="empirical_source_mode" :value="empiricalSourceMode">
                    <input type="hidden" name="empirical_folder_path" :value="empiricalFolderPath">
                    <input type="hidden" name="simulation_file_path" :value="simulationFilePath">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="flex flex-col bg-white dark:bg-[#111422] border border-gray-200 dark:border-[#323b67] rounded-xl p-6">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="material-symbols-outlined text-primary">history</span>
                                <h3 class="font-bold text-base text-[#34495E] dark:text-white">Continue simulation pipeline</h3>
                            </div>
                            <div class="space-y-2">
                                <template x-if="pipelineFiles.length === 0">
                                    <p class="text-xs text-gray-500 dark:text-gray-400">No field potential outputs detected yet.</p>
                                </template>
                                <template x-for="entry in pipelineFiles" :key="entry.path">
                                    <button type="button" @click="selectPipeline(entry.path)"
                                        class="w-full flex items-center justify-between p-3 text-sm border border-gray-100 dark:border-white/10 rounded-lg hover:bg-primary/5 hover:border-primary/30 transition-all text-left group"
                                        :class="{ 'border-primary bg-primary/5': selectedPipelinePath === entry.path }">
                                        <span class="truncate flex items-center gap-2">
                                            <span class="material-symbols-outlined text-sm opacity-60">analytics</span>
                                            <span class="truncate" x-text="entry.name"></span>
                                        </span>
                                        <span class="material-symbols-outlined text-lg text-primary"
                                            :class="selectedPipelinePath === entry.path ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'">check_circle</span>
                                    </button>
                                </template>
                            </div>
                            <div x-show="selectedPipelinePath" class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                                <p x-text="pipelineFiles.find((item) => item.path === selectedPipelinePath)?.source || ''"></p>
                            </div>
                        </div>

                        <div class="flex flex-col bg-white dark:bg-[#111422] border border-gray-200 dark:border-[#323b67] rounded-xl p-6">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="material-symbols-outlined text-primary">add_circle</span>
                                <h3 class="font-bold text-base text-[#34495E] dark:text-white">New data</h3>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">
                                Load one of two data types: a simulation output representing field potentials, or empirical electrophysiological recordings.
                            </p>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                                <button type="button" @click="setNewDataMode('new-simulation')"
                                    class="px-3 py-2 text-xs rounded-lg border transition-colors"
                                    :class="activeNewDataMode() === 'new-simulation' ? 'bg-primary/10 border-primary text-primary' : 'border-gray-200 dark:border-[#323b67] text-gray-600 dark:text-gray-300'">
                                    Simulation output
                                </button>
                                <button type="button" @click="setNewDataMode('new-empirical')"
                                    class="px-3 py-2 text-xs rounded-lg border transition-colors"
                                    :class="activeNewDataMode() === 'new-empirical' ? 'bg-primary/10 border-primary text-primary' : 'border-gray-200 dark:border-[#323b67] text-gray-600 dark:text-gray-300'">
                                    Empirical recordings
                                </button>
                            </div>

                            <div x-show="activeNewDataMode() === 'new-simulation'" x-cloak>
                                <div class="space-y-3">
                                    <label class="text-sm block">
                                        <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Simulation output file path on server *</span>
                                        <input type="text" x-model="simulationFilePath" @keydown.enter.prevent="inspectSimulationFilePath()"
                                            class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                            placeholder="/absolute/path/to/simulation_output.pkl">
                                    </label>
                                    <div class="flex flex-wrap gap-2">
                                        <button type="button" @click="pickSimulationFile()"
                                            class="h-10 px-4 border border-gray-300 dark:border-[#323b67] text-sm rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-[#191e33] transition-colors">
                                            Browse file
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Data is read directly from server path (no HTTP upload).</p>
                                </div>
                                <div x-show="simulationFileCount > 0" class="mt-4 p-3 bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 text-sm font-medium rounded-lg">
                                    <p>1 file detected.</p>
                                    <p class="text-xs opacity-80">Sample inspected: <span x-text="simulationSampleName"></span></p>
                                </div>
                            </div>

                            <div x-show="activeNewDataMode() === 'new-empirical'" x-cloak>
                                <div class="space-y-3">
                                    <label class="text-sm block">
                                        <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Empirical folder path on server *</span>
                                        <input type="text" x-model="empiricalFolderPath" @keydown.enter.prevent="inspectEmpiricalFolderPath()"
                                            class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                            placeholder="/absolute/path/to/empirical/folder">
                                    </label>
                                    <div class="flex flex-wrap gap-2">
                                        <button type="button" @click="pickEmpiricalFolder()"
                                            class="h-10 px-4 border border-gray-300 dark:border-[#323b67] text-sm rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-[#191e33] transition-colors">
                                            Browse folder
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Data is read directly from server path (no HTTP upload).</p>
                                </div>

                                <div x-show="empiricalFileCount > 0" class="mt-4 p-3 bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 text-sm font-medium rounded-lg">
                                    <p><span x-text="empiricalFileCount"></span> file(s) detected.</p>
                                    <p class="text-xs opacity-80">Sample inspected: <span x-text="empiricalSampleName"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div x-show="hasAnyData()" x-cloak class="mt-6 bg-white dark:bg-[#111422] border border-gray-200 dark:border-[#323b67] rounded-xl p-6">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="material-symbols-outlined text-primary">tune</span>
                            <h3 class="font-bold text-base text-[#34495E] dark:text-white">Configure EphysDatasetParser</h3>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
                            Selected source: <span class="font-semibold" x-text="selectedDataDescription()"></span>
                        </p>

                        <div x-show="parserLoading" class="text-sm text-gray-500 dark:text-gray-400">Inspecting selected data...</div>
                        <div x-show="parserError" class="text-sm text-red-600 dark:text-red-400" x-text="parserError"></div>

                        <template x-if="parserInfo">
                            <div class="space-y-4">
                                <p class="text-xs text-gray-500 dark:text-gray-400" x-text="parserInfo.summary"></p>

                                <div x-show="resolvedDataSourceKind() === 'pipeline' || resolvedDataSourceKind() === 'new-simulation'" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Data locator *</span>
                                            <select name="parser_data_locator" x-model="parserDataLocator"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                                <option value="">Select</option>
                                                <template x-for="field in parserInfo.candidate_fields || []" :key="'pipeline-data-'+field">
                                                    <option :value="field" x-text="field"></option>
                                                </template>
                                            </select>
                                        </label>
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Sampling frequency source *</span>
                                            <select name="parser_fs_source" x-model="parserFsSource" @change="onPipelineFsSourceChange()"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                                <option value="__numeric__">Numeric value</option>
                                                <template x-for="field in parserInfo.candidate_fields || []" :key="'pipeline-fs-source-'+field">
                                                    <option :value="field" x-text="field"></option>
                                                </template>
                                                <option value="__none__">None</option>
                                            </select>
                                        </label>
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Sampling frequency (Hz) value</span>
                                            <input type="number" step="any" min="0" name="parser_fs_manual" x-model="parserFsManual"
                                                :disabled="parserFsSource !== '__numeric__'"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm disabled:opacity-50"
                                                placeholder="e.g. 16000 for dt=0.0625 ms">
                                        </label>
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Channel names source *</span>
                                            <select name="parser_ch_names_source" x-model="parserChNamesSource" @change="onParserChNamesSourceChange()"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                                <option value="__manual__">Manual list</option>
                                                <template x-for="field in parserInfo.candidate_fields || []" :key="'pipeline-ch-source-'+field">
                                                    <option :value="field" x-text="field"></option>
                                                </template>
                                                <option value="__autocomplete__">Autocomplete</option>
                                            </select>
                                        </label>
                                    </div>
                                    <input type="hidden" name="parser_fs_locator"
                                        :value="(parserFsSource && parserFsSource !== '__numeric__' && parserFsSource !== '__none__') ? parserFsSource : ''">
                                    <input type="hidden" name="parser_ch_names_locator"
                                        :value="(parserChNamesSource && parserChNamesSource !== '__manual__' && parserChNamesSource !== '__autocomplete__') ? parserChNamesSource : ''">
                                    <label class="text-sm" x-show="parserChNamesSource === '__manual__'">
                                        <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Channel names (comma-separated)</span>
                                        <input type="text" name="parser_sensor_names" x-model="parserSensorNames"
                                            :disabled="parserChNamesSource !== '__manual__'"
                                            class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm disabled:opacity-50"
                                            placeholder="e.g. ch0, ch1, ch2">
                                    </label>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Recording type source *</span>
                                            <select name="parser_recording_type_source" x-model="parserRecordingTypeSource" @change="onPipelineRecordingTypeSourceChange()"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                                <option value="__value__">Value</option>
                                                <template x-for="field in parserInfo.candidate_fields || []" :key="'pipeline-rec-type-source-'+field">
                                                    <option :value="field" x-text="field"></option>
                                                </template>
                                                <option value="__none__">None</option>
                                            </select>
                                        </label>
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Recording type value</span>
                                            <select name="parser_recording_type" x-model="parserRecordingType"
                                                :disabled="parserRecordingTypeSource !== '__value__'"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm disabled:opacity-50">
                                                <option value="LFP">LFP</option>
                                                <option value="CDM">CDM</option>
                                                <option value="EEG">EEG</option>
                                                <option value="MEG">MEG</option>
                                                <option value="ECoG">ECoG</option>
                                                <option value="Unknown">Unknown</option>
                                            </select>
                                        </label>
                                    </div>
                                    <input type="hidden" name="parser_recording_type_locator"
                                        :value="(parserRecordingTypeSource && parserRecordingTypeSource !== '__value__' && parserRecordingTypeSource !== '__none__') ? parserRecordingTypeSource : ''">

                                    <p class="text-xs text-gray-500 dark:text-gray-400">Metadata is auto-filled as one synthetic subject.</p>
                                    <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                        <input type="checkbox" x-model="parserZscore"
                                            class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                        Apply z-score normalization
                                    </label>

                                </div>

                                <div x-show="resolvedDataSourceKind() === 'new-empirical'" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Data locator *</span>
                                            <select name="parser_data_locator" x-model="parserDataLocator"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                                <option value="">Select</option>
                                                <template x-for="field in parserInfo.candidate_fields || []" :key="'data-'+field">
                                                    <option :value="field" x-text="field"></option>
                                                </template>
                                            </select>
                                        </label>
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Sampling frequency source *</span>
                                            <select name="parser_fs_source" x-model="parserFsSource" @change="onPipelineFsSourceChange()"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                                <option value="__numeric__">Numeric value</option>
                                                <template x-for="field in parserInfo.candidate_fields || []" :key="'fs-source-'+field">
                                                    <option :value="field" x-text="field"></option>
                                                </template>
                                                <option value="__none__">None</option>
                                            </select>
                                        </label>
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Sampling frequency (Hz) value</span>
                                            <input type="number" step="any" min="0" name="parser_fs_manual" x-model="parserFsManual"
                                                :disabled="parserFsSource !== '__numeric__'"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm disabled:opacity-50"
                                                placeholder="e.g. 16000 for dt=0.0625 ms">
                                        </label>
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Channel names source *</span>
                                            <select name="parser_ch_names_source" x-model="parserChNamesSource" @change="onParserChNamesSourceChange()"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                                <option value="__manual__">Manual list</option>
                                                <template x-for="field in parserInfo.candidate_fields || []" :key="'ch-source-'+field">
                                                    <option :value="field" x-text="field"></option>
                                                </template>
                                                <option value="__autocomplete__">Autocomplete</option>
                                            </select>
                                        </label>
                                    </div>
                                    <input type="hidden" name="parser_fs_locator"
                                        :value="(parserFsSource && parserFsSource !== '__numeric__' && parserFsSource !== '__none__') ? parserFsSource : ''">
                                    <input type="hidden" name="parser_ch_names_locator"
                                        :value="(parserChNamesSource && parserChNamesSource !== '__manual__' && parserChNamesSource !== '__autocomplete__') ? parserChNamesSource : ''">
                                    <label class="text-sm" x-show="parserChNamesSource === '__manual__'">
                                        <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Channel names (comma-separated)</span>
                                        <input type="text" name="parser_sensor_names" x-model="parserSensorNames"
                                            :disabled="parserChNamesSource !== '__manual__'"
                                            class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm disabled:opacity-50"
                                            placeholder="e.g. ch0, ch1, ch2">
                                    </label>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Recording type source *</span>
                                            <select name="parser_recording_type_source" x-model="parserRecordingTypeSource" @change="onPipelineRecordingTypeSourceChange()"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                                <option value="__value__">Value</option>
                                                <template x-for="field in parserInfo.candidate_fields || []" :key="'rec-source-'+field">
                                                    <option :value="field" x-text="field"></option>
                                                </template>
                                                <option value="__none__">None</option>
                                            </select>
                                        </label>
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Recording type value</span>
                                            <select name="parser_recording_type" x-model="parserRecordingType"
                                                :disabled="parserRecordingTypeSource !== '__value__'"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm disabled:opacity-50">
                                                <option value="LFP">LFP</option>
                                                <option value="CDM">CDM</option>
                                                <option value="EEG">EEG</option>
                                                <option value="MEG">MEG</option>
                                                <option value="ECoG">ECoG</option>
                                                <option value="Unknown">Unknown</option>
                                            </select>
                                        </label>
                                    </div>
                                    <input type="hidden" name="parser_recording_type_locator"
                                        :value="(parserRecordingTypeSource && parserRecordingTypeSource !== '__value__' && parserRecordingTypeSource !== '__none__') ? parserRecordingTypeSource : ''">

                                    <div x-show="resolvedDataSourceKind() === 'new-empirical'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Subject ID column</span>
                                            <select name="parser_subject_id_locator" x-model="parserSubjectIdLocator"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                                <option value="">None</option>
                                                <option value="__file_id__">Each file (file_ID)</option>
                                                <template x-for="field in parserInfo.candidate_fields || []" :key="'subject-id-source-'+field">
                                                    <option :value="field" x-text="field"></option>
                                                </template>
                                            </select>
                                        </label>
                                        <label class="text-sm">
                                            <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Group column</span>
                                            <select name="parser_group_locator" x-model="parserGroupLocator"
                                                class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                                <option value="">None</option>
                                                <template x-for="field in parserInfo.candidate_fields || []" :key="'group-source-'+field">
                                                    <option :value="field" x-text="field"></option>
                                                </template>
                                            </select>
                                        </label>
                                    </div>

                                    <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                        <input type="checkbox" x-model="parserZscore"
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                        Apply z-score normalization
                                    </label>

                                </div>

                                <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                    <input type="checkbox" x-model="parserEnableEpoching"
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                    Enable epoching
                                </label>
                                <input type="hidden" name="parser_enable_epoching" :value="parserEnableEpoching ? '1' : '0'">

                                <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                    <input type="checkbox" x-model="parserEnableAggregate"
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                    Enable aggregation
                                </label>
                                <input type="hidden" name="parser_enable_aggregate" :value="parserEnableAggregate ? '1' : '0'">
                                <input type="hidden" name="parser_aggregate_over" :value="(parserAggregateOverSelected || []).join(',')">

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" x-show="parserEnableAggregate">
                                    <label class="text-sm">
                                        <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Aggregate over fields</span>
                                        <select multiple x-model="parserAggregateOverSelected"
                                            class="w-full min-h-32 rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                            <template x-for="field in aggregateOverOptions()" :key="'agg-over-'+field">
                                                <option :value="field" x-text="field"></option>
                                            </template>
                                        </select>
                                        <span class="block text-[11px] text-gray-400 mt-1">Choose one or more fields.</span>
                                    </label>
                                    <label class="text-sm">
                                        <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Aggregate method</span>
                                        <select name="parser_aggregate_method" x-model="parserAggregateMethod"
                                            class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                            <option value="sum">sum</option>
                                            <option value="mean">mean</option>
                                            <option value="median">median</option>
                                        </select>
                                    </label>
                                    <label class="text-sm">
                                        <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Aggregate labels (dict)</span>
                                        <input type="text" name="parser_aggregate_labels" x-model="parserAggregateLabels"
                                            class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                            placeholder="e.g. {'sensor': 'all'}">
                                    </label>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" x-show="parserEnableEpoching">
                                    <label class="text-sm">
                                        <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Epoch length (s)</span>
                                        <input type="number" step="any" name="parser_epoch_length_s" x-model="parserEpochLengthS"
                                            class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                    </label>
                                    <label class="text-sm">
                                        <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Epoch step (s)</span>
                                        <input type="number" step="any" name="parser_epoch_step_s" x-model="parserEpochStepS"
                                            class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                    </label>
                                </div>
                                <input type="hidden" name="parser_zscore" :value="parserZscore ? '1' : '0'">
                            </div>
                        </template>
                    </div>

                    <div x-show="activeTab === 'load-data' && hasAnyData()" x-cloak class="mt-8 rounded-xl border border-slate-700 bg-slate-950 text-slate-100 overflow-hidden">
                        <div class="px-4 py-2 border-b border-slate-800 flex items-center gap-2 text-xs uppercase tracking-wide text-slate-400">
                            <span class="material-symbols-outlined text-sm">terminal</span>
                            EphysDatasetParser Debug Terminal
                        </div>
                        <pre class="p-4 text-xs leading-relaxed font-mono whitespace-pre-wrap overflow-x-auto max-h-96" x-text="parserDebugCode()"></pre>
                    </div>
                </div>

                <div x-show="activeTab === 'select-method'" x-cloak>
                    <div class="pt-8">
                        <div class="bg-white border border-gray-200 rounded-xl p-6 dark:bg-[#111422] dark:border-[#323b67]">
                            <h2 class="text-[#34495E] text-[22px] font-bold leading-tight tracking-[-0.015em] mb-4 dark:text-gray-100">Select Method</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <template :key="method.key" x-for="method in methods">
                                    <label
                                        class="flex items-start p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors dark:bg-[#111422] dark:border-[#323b67] dark:hover:border-gray-500 dark:hover:bg-white/10"
                                        :class="{ 'border-primary bg-primary/5': selectedMethod === method.value }">
                                        <input :value="method.value" x-model="selectedMethod"
                                            class="form-radio h-4 w-4 mt-0.5 text-primary focus:ring-primary/50 border-gray-300 bg-background-light"
                                            name="select-method" type="radio" />
                                        <span class="ml-3">
                                            <span class="block text-sm font-semibold text-[#34495E] dark:text-gray-200" x-text="method.label"></span>
                                            <span class="block text-xs text-gray-500 dark:text-gray-400" x-text="method.description"></span>
                                        </span>
                                    </label>
                                </template>
                            </div>
                            <div class="mt-4 p-3 dark:bg-gray-800 bg-gray-50 rounded-lg" x-show="selectedMethod">
                                <p class="text-sm text-gray-600 dark:text-gray-300">
                                    Selected: <span class="font-semibold text-primary" x-text="methods.find(m => m.value === selectedMethod)?.label"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-show="activeTab === 'configure-method'" x-cloak>
                    <h1 class="text-[#34495E] dark:text-white text-3xl font-black leading-tight tracking-[-0.02em] py-4">
                        Method Configuration
                    </h1>

                    <div x-show="!selectedMethod" class="text-center py-8">
                        <p class="text-gray-500">Please select a method in the previous tab first.</p>
                        <button @click="activeTab = 'select-method'" type="button"
                            class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            Go Back to Select Method
                        </button>
                    </div>

                    <div x-show="selectedMethod" class="space-y-6">
                        <section class="bg-white dark:bg-[#111422] border border-gray-200 dark:border-[#323b67] rounded-xl p-6">
                            <h2 class="text-lg font-semibold text-[#34495E] dark:text-white mb-4">Execution settings</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Parallel workers (n_jobs)</span>
                                    <input type="number" min="1" step="1" name="features_n_jobs"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        value="1">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Chunksize</span>
                                    <input type="number" min="1" step="1" name="features_chunksize"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Start method</span>
                                    <select name="features_start_method"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                        <option value="spawn">spawn</option>
                                        <option value="fork">fork</option>
                                        <option value="forkserver">forkserver</option>
                                    </select>
                                </label>
                            </div>
                        </section>

                        <section x-show="selectedMethod === 'catch22'" class="bg-white dark:bg-[#111422] border border-gray-200 dark:border-[#323b67] rounded-xl p-6">
                            <h2 class="text-lg font-semibold text-[#34495E] dark:text-white mb-4">catch22 options</h2>
                            <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                <input type="checkbox" name="catch22_normalize" value="1"
                                    class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                Normalize each sample before feature extraction
                            </label>
                        </section>

                        <section x-show="selectedMethod === 'specparam'" class="bg-white dark:bg-[#111422] border border-gray-200 dark:border-[#323b67] rounded-xl p-6 space-y-5">
                            <h2 class="text-lg font-semibold text-[#34495E] dark:text-white">specparam options</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Sampling frequency (Hz)</span>
                                    <input type="number" step="any" name="specparam_fs"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional: fallback to parsed dataframe fs">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Select peak</span>
                                    <select name="specparam_select_peak"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                        <option value="max_pw">max_pw</option>
                                        <option value="max_cf_in_range">max_cf_in_range</option>
                                        <option value="all">all</option>
                                    </select>
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Frequency range min (Hz)</span>
                                    <input type="number" step="any" name="specparam_freq_min" value="1.0"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Frequency range max (Hz)</span>
                                    <input type="number" step="any" name="specparam_freq_max" value="45.0"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Welch nperseg</span>
                                    <input type="number" step="1" min="1" name="specparam_welch_nperseg"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Welch noverlap</span>
                                    <input type="number" step="1" min="0" name="specparam_welch_noverlap"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                            </div>

                            <div class="grid grid-cols-1 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Welch kwargs (JSON/dict)</span>
                                    <textarea name="specparam_welch_kwargs" rows="2"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="e.g. {'detrend': 'constant'}"></textarea>
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">SpectralModel kwargs (JSON/dict)</span>
                                    <textarea name="specparam_model_kwargs" rows="2"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="e.g. {'peak_width_limits': [1, 8], 'max_n_peaks': 6}"></textarea>
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Metric policy</span>
                                    <select name="specparam_metric_policy"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                        <option value="reject">reject</option>
                                        <option value="flag">flag</option>
                                    </select>
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Threshold gof_rsquared</span>
                                    <input type="number" min="0" max="1" step="any" name="specparam_threshold_gof_rsquared"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                            </div>

                            <label class="text-sm block">
                                <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Additional metric thresholds (JSON/dict)</span>
                                <textarea name="specparam_metric_thresholds" rows="2"
                                    class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                    placeholder="e.g. {'gof_rsquared': 0.95}"></textarea>
                            </label>

                            <div class="flex flex-wrap gap-5">
                                <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                    <input type="checkbox" name="specparam_debug" value="1"
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                    Debug mode
                                </label>
                                <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                    <input type="checkbox" name="specparam_normalize" value="1"
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                    Normalize each sample
                                </label>
                            </div>
                        </section>

                        <section x-show="selectedMethod === 'dfa'" class="bg-white dark:bg-[#111422] border border-gray-200 dark:border-[#323b67] rounded-xl p-6 space-y-5">
                            <h2 class="text-lg font-semibold text-[#34495E] dark:text-white">DFA options</h2>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Sampling frequency (Hz)</span>
                                    <input type="number" step="any" name="dfa_sampling_frequency"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional: fallback to parsed dataframe fs">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Analysis mode</span>
                                    <select x-model="dfaAnalysisMode" name="dfa_analysis_mode"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                        <option value="envelope">envelope input</option>
                                        <option value="frequency_range">single frequency range</option>
                                        <option value="spectrum_range">spectrum bins</option>
                                    </select>
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Fit interval min (s)</span>
                                    <input type="number" step="any" name="dfa_fit_min"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Required for envelope mode">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Fit interval max (s)</span>
                                    <input type="number" step="any" name="dfa_fit_max"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Required for envelope mode">
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Compute interval min (s)</span>
                                    <input type="number" step="any" name="dfa_compute_min"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Required for envelope mode">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Compute interval max (s)</span>
                                    <input type="number" step="any" name="dfa_compute_max"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Required for envelope mode">
                                </label>
                            </div>

                            <div x-show="dfaAnalysisMode === 'frequency_range'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Frequency range min (Hz)</span>
                                    <input type="number" step="any" name="dfa_frequency_min"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Frequency range max (Hz)</span>
                                    <input type="number" step="any" name="dfa_frequency_max"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                            </div>

                            <div x-show="dfaAnalysisMode === 'spectrum_range'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Spectrum range min (Hz)</span>
                                    <input type="number" step="any" name="dfa_spectrum_min"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        value="1.0">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Spectrum range max (Hz)</span>
                                    <input type="number" step="any" name="dfa_spectrum_max"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        value="45.0">
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Bad channel indices</span>
                                    <input type="text" name="dfa_bad_idxes"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="e.g. 1,3,5">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Trim seconds</span>
                                    <input type="number" step="any" name="dfa_trim_seconds" value="1.0"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Hilbert n_fft</span>
                                    <input type="number" step="1" min="1" name="dfa_hilbert_n_fft"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                            </div>

                            <label class="text-sm block">
                                <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Filter kwargs (JSON/dict)</span>
                                <textarea name="dfa_filter_kwargs" rows="2"
                                    class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                    placeholder="e.g. {'fir_design': 'firwin'}"></textarea>
                            </label>

                            <div class="flex flex-wrap gap-5">
                                <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                    <input type="checkbox" name="dfa_overlap" value="1" checked
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                    Overlap windows (50%)
                                </label>
                                <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                    <input type="checkbox" name="dfa_input_is_envelope" value="1" checked
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                    Input is already an envelope
                                </label>
                                <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                    <input type="checkbox" name="dfa_normalize" value="1"
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                    Normalize each sample
                                </label>
                            </div>
                        </section>

                        <section x-show="selectedMethod === 'fEI'" class="bg-white dark:bg-[#111422] border border-gray-200 dark:border-[#323b67] rounded-xl p-6 space-y-5">
                            <h2 class="text-lg font-semibold text-[#34495E] dark:text-white">fEI options</h2>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Sampling frequency (Hz)</span>
                                    <input type="number" step="any" name="fei_sampling_frequency"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional: fallback to parsed dataframe fs">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Analysis mode</span>
                                    <select x-model="fEIAnalysisMode" name="fei_analysis_mode"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                        <option value="envelope">envelope input</option>
                                        <option value="frequency_range">single frequency range</option>
                                        <option value="spectrum_range">spectrum bins</option>
                                    </select>
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Window size (s)</span>
                                    <input type="number" step="any" name="fei_window_size_sec"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Required">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Window overlap [0,1)</span>
                                    <input type="number" min="0" max="0.99" step="any" name="fei_window_overlap" value="0.0"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">DFA value (optional)</span>
                                    <input type="number" step="any" name="fei_dfa_value"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Single-channel envelope only">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">DFA threshold</span>
                                    <input type="number" min="0" max="1" step="any" name="fei_dfa_threshold" value="0.6"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Hilbert n_fft</span>
                                    <input type="number" step="1" min="1" name="fei_hilbert_n_fft"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">DFA fit interval min (s)</span>
                                    <input type="number" step="any" name="fei_dfa_fit_min"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">DFA fit interval max (s)</span>
                                    <input type="number" step="any" name="fei_dfa_fit_max"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">DFA compute interval min (s)</span>
                                    <input type="number" step="any" name="fei_dfa_compute_min"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">DFA compute interval max (s)</span>
                                    <input type="number" step="any" name="fei_dfa_compute_max"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                            </div>

                            <div x-show="fEIAnalysisMode === 'frequency_range'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Frequency range min (Hz)</span>
                                    <input type="number" step="any" name="fei_frequency_min"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Frequency range max (Hz)</span>
                                    <input type="number" step="any" name="fei_frequency_max"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                            </div>

                            <div x-show="fEIAnalysisMode === 'spectrum_range'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Spectrum range min (Hz)</span>
                                    <input type="number" step="any" name="fei_spectrum_min" value="1.0"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Spectrum range max (Hz)</span>
                                    <input type="number" step="any" name="fei_spectrum_max" value="45.0"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Bad channel indices</span>
                                    <input type="text" name="fei_bad_idxes"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="e.g. 1,3,5">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Trim seconds</span>
                                    <input type="number" step="any" name="fei_trim_seconds" value="1.0"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm">
                                </label>
                                <label class="text-sm">
                                    <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Filter kwargs (JSON/dict)</span>
                                    <input type="text" name="fei_filter_kwargs"
                                        class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                        placeholder="Optional">
                                </label>
                            </div>

                            <div class="flex flex-wrap gap-5">
                                <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                    <input type="checkbox" name="fei_dfa_overlap" value="1" checked
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                    DFA overlap (50%)
                                </label>
                                <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                    <input type="checkbox" name="fei_input_is_envelope" value="1" checked
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                    Input is already an envelope
                                </label>
                                <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                    <input type="checkbox" name="fei_normalize" value="1"
                                        class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                    Normalize each sample
                                </label>
                            </div>
                        </section>

                        <section x-show="selectedMethod === 'hctsa'" class="bg-white dark:bg-[#111422] border border-gray-200 dark:border-[#323b67] rounded-xl p-6 space-y-4">
                            <h2 class="text-lg font-semibold text-[#34495E] dark:text-white">hctsa options</h2>
                            <label class="text-sm block">
                                <span class="block text-xs text-gray-500 dark:text-gray-400 mb-1">hctsa_folder *</span>
                                <input type="text" name="hctsa_folder"
                                    class="w-full rounded-lg border-gray-300 dark:border-[#323b67] bg-background-light dark:bg-[#191e33] text-sm"
                                    placeholder="Path to hctsa installation">
                            </label>
                            <label class="inline-flex items-center gap-2 text-sm text-[#34495E] dark:text-gray-300">
                                <input type="checkbox" name="hctsa_return_meta" value="1"
                                    class="rounded border-gray-300 text-primary focus:ring-primary/50">
                                Return hctsa metadata summary
                            </label>
                        </section>
                    </div>
                </div>
            </div>

            <div x-show="submitInProgress || submitError" x-cloak
                class="mt-8 w-full p-4 bg-white dark:bg-[#111422] border border-gray-200 dark:border-[#323b67] rounded-xl space-y-3">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">cloud_upload</span>
                    <p class="text-sm font-medium text-[#34495E] dark:text-white" x-text="uploadStatusMessage || 'Uploading files...'"></p>
                </div>
                <div x-show="hasUploadPayload()" class="w-full h-2 rounded-full bg-gray-200 dark:bg-[#323b67] overflow-hidden relative">
                    <div x-show="uploadProgressKnown" class="h-full bg-primary transition-all duration-200" :style="`width: ${Math.max(0, Math.min(100, uploadProgress))}%`"></div>
                    <div x-show="!uploadProgressKnown" class="absolute inset-y-0 left-0 w-1/3 bg-primary/70 upload-indeterminate"></div>
                </div>
                <p x-show="uploadBytesTotal > 0" class="text-xs text-gray-500 dark:text-gray-400"
                    x-text="`${formatBytes(uploadBytesLoaded)} / ${formatBytes(uploadBytesTotal)}`"></p>
                <p x-show="submitError" class="text-xs text-red-600 dark:text-red-400" x-text="submitError"></p>
            </div>

            <div class="mt-10 flex flex-col sm:flex-row justify-between items-center gap-4">
                <template x-if="activeTab === 'load-data'">
                    <a href="{{ url_for('dashboard') }}"
                        class="flex items-center justify-center gap-2 h-12 px-6 w-full sm:w-auto text-primary dark:text-white font-bold text-base rounded-lg hover:bg-primary/10 dark:hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors border border-primary dark:border-white/50">
                        <span class="material-symbols-outlined">arrow_back</span>
                        Return to ncpi dashboard
                    </a>
                </template>

                <template x-if="activeTab !== 'load-data'">
                    <button type="button"
                        @click="if (activeTab === 'select-method') { activeTab = 'load-data' } else if (activeTab === 'configure-method') { activeTab = 'select-method' }"
                        class="flex items-center justify-center gap-2 h-12 px-6 w-full sm:w-auto text-primary dark:text-white font-bold text-base rounded-lg hover:bg-primary/10 dark:hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors border border-primary dark:border-white/50">
                        <span class="material-symbols-outlined">arrow_back</span>
                        Back step
                    </button>
                </template>

                <template x-if="activeTab === 'configure-method' && canSubmitFeatures()">
                    <button type="submit"
                        :disabled="submitInProgress"
                        :class="submitInProgress ? 'opacity-70 cursor-not-allowed' : ''"
                        class="flex items-center justify-center gap-2 h-12 px-6 w-full sm:w-auto bg-primary text-white font-bold text-base rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors">
                        <span x-text="submitInProgress ? (hasUploadPayload() ? 'Uploading files...' : 'Processing...') : 'Compute features'"></span>
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </button>
                </template>

                <template x-if="activeTab !== 'configure-method' && hasAnyData()">
                    <button type="button"
                        @click="if (activeTab === 'load-data') { activeTab = 'select-method' } else if (activeTab === 'select-method') { activeTab = 'configure-method' }"
                        class="flex items-center justify-center gap-2 h-12 px-6 w-full sm:w-auto bg-primary text-white font-bold text-base rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors">
                        Next step
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </button>
                </template>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script defer src="{{ url_for('static', filename='js/handleFileUpload.js') }}"></script>
<script>
    (() => {
        const featuresUploadForm = document.getElementById('featuresUploadForm');
        const featuresFileInput = document.getElementById('featuresFileInput');
        const featuresDropZone = document.getElementById('featuresDropZone');

        if (!featuresUploadForm || !featuresFileInput || !featuresDropZone) {
            return;
        }

        const submitFeaturesIfReady = () => {
            if (featuresFileInput.files && featuresFileInput.files.length > 0) {
                featuresUploadForm.submit();
            }
        };

        const renderSelectedFeaturesFiles = (files) => {
            const selectedFiles = document.getElementById('selectedFeaturesFiles');
            const selectedFilesList = document.getElementById('selectedFeaturesFilesList');
            if (!selectedFiles || !selectedFilesList) {
                return;
            }
            selectedFilesList.innerHTML = '';
            Array.from(files).forEach((file) => {
                const line = document.createElement('span');
                line.className = 'block';
                line.textContent = file.name;
                selectedFilesList.appendChild(line);
            });
            selectedFiles.classList.remove('hidden');
        };

        const setFeaturesInputFiles = (files) => {
            const dataTransfer = new DataTransfer();
            Array.from(files).forEach((file) => dataTransfer.items.add(file));
            featuresFileInput.files = dataTransfer.files;
        };

        featuresFileInput.addEventListener('change', () => {
            renderSelectedFeaturesFiles(featuresFileInput.files);
            submitFeaturesIfReady();
        });

        ['dragenter', 'dragover'].forEach((eventName) => {
            featuresDropZone.addEventListener(eventName, (event) => {
                event.preventDefault();
                featuresDropZone.classList.add('simulation-accent-border');
            });
        });

        ['dragleave', 'drop'].forEach((eventName) => {
            featuresDropZone.addEventListener(eventName, (event) => {
                event.preventDefault();
                featuresDropZone.classList.remove('simulation-accent-border');
            });
        });

        featuresDropZone.addEventListener('drop', (event) => {
            const files = event.dataTransfer.files;
            if (!files || files.length === 0) {
                return;
            }
            setFeaturesInputFiles(files);
            renderSelectedFeaturesFiles(files);
            submitFeaturesIfReady();
        });
    })();
</script>
{% endblock %}
