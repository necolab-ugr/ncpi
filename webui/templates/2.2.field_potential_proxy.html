{% extends "2.field_potential.html" %}
{% block title %}Field Potential proxy{% endblock %}

{% block head %}
{{ super() }}
<style type="text/tailwindcss">
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
    }
    .upload-zone:hover {
        @apply border-primary bg-primary/5;
    }
</style>
{% endblock %}


<!-- Main content of the field potential proxy page -->
{% block content %}
<div class="px-4 md:px-8 lg:px-20 flex justify-center">
    <div class="layout-content-container flex flex-col max-w-[900px]">
        <div class="mb-10">
            <h1 class="text-3xl font-black leading-tight tracking-[-0.033em] mb-2">Field Potential Configuration: Proxy</h1>
            <p class="text-slate-500 dark:text-slate-400 text-base">Configure the parameters and upload data for direct proxy
                estimation.</p>
        </div>

        <!-- Form action -->
        <form class="flex flex-col gap-8" method="POST" enctype="multipart/form-data"
            action="{{ url_for('start_computation_redirect', computation_type='field_potential_proxy') }}">
            
            <!-- Proxy method selection -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-bold">Proxy Method</label>
                    <select onchange="updateFormVisibility()" id="proxyMethod" name="proxy_method"
                        class="form-select w-full h-12 rounded-lg border-slate-300 dark:border-slate-700 dark:bg-slate-900 focus:ring-primary focus:border-primary">
                        <option value="FR">Firing Rate (FR): mean firing rate</option>
                        <option value="AMPA">AMPA: sum of AMPA currents</option>
                        <option value="GABA">GABA: sum of GABA currents</option>
                        <option value="Vm">Vm: Sum of membrane potentials</option>
                        <option value="I">I: sum of synaptic currents</option>
                        <option value="I_abs">I abs: sum of their absolute values</option>
                        <option value="LRWS">LRWS: LFP reference weighted sum</option>
                        <option value="ERWS1">ERWS1: EEG reference weighted sum 1 (non-causal)</option>
                        <option value="ERWS2">ERWS2: EEG reference weighted sum 2 (non-causal)</option>
                    </select>
                </div>
                <div id="simulationStepContainer" class="flex flex-col gap-2">
                    <label class="text-sm font-bold">Simulation Step (ms)</label>
                    <input
                        class="form-input w-full h-12 rounded-lg border-slate-300 dark:border-slate-700 dark:bg-slate-900 focus:ring-primary focus:border-primary"
                        step="0.1" type="number" value="0.1" name="sim_step" />
                </div>
                <div id="frBinSizeContainer" class="flex flex-col gap-2">
                    <label class="text-sm font-bold">Firing Rate Bin Size (ms)</label>
                    <input
                        class="form-input w-full h-12 rounded-lg border-slate-300 dark:border-slate-700 dark:bg-slate-900 focus:ring-primary focus:border-primary"
                        step="0.1" type="number" value="1.0" name="bin_size" />
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-bold">Excitatory Only</label>
                    <select
                        name="excitatory_only"
                        class="form-select w-full h-12 rounded-lg border-slate-300 dark:border-slate-700 dark:bg-slate-900 focus:ring-primary focus:border-primary">
                        <option value="default">Default</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
            </div>

            <!-- Data sources (if needed) -->
            <div class="space-y-4">
                <h3 class="text-lg font-bold border-b border-slate-200 dark:border-slate-800 pb-2">Simulation data</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="timesUploadContainer"
                        data-upload="timesFile"
                        class="upload-zone border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-6 flex flex-col items-center justify-center gap-2 cursor-pointer transition-all bg-white dark:bg-slate-900/50">
                        <input class="hidden" type="file" id="timesFile" name="times_file" accept=".pkl" />
                        <span class="material-symbols-outlined text-slate-400">upload_file</span>
                        <span class="text-xs font-bold lowercase tracking-wider text-slate-500">Spike times (times.pkl)</span>
                        <p class="text-[10px] text-slate-400">Default: {{ default_sim_paths.times }}</p>
                        <p class="text-[10px] text-slate-500" data-filename>Not selected</p>
                        <div class="mt-2 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-[10px] font-semibold px-2 py-1 {% if not default_sim.times %}hidden{% endif %}"
                            data-uploaded data-default-name="{{ 'times.pkl' if default_sim.times else '' }}">
                            <span data-uploaded-label>{% if default_sim.times %}Loaded{% else %}Uploaded{% endif %}</span>: <span data-uploaded-name>{% if default_sim.times %}times.pkl{% endif %}</span>
                        </div>
                    </div>
                    <div id="gidsUploadContainer"
                        data-upload="gidsFile"
                        class="upload-zone border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-6 flex flex-col items-center justify-center gap-2 cursor-pointer transition-all bg-white dark:bg-slate-900/50">
                        <input class="hidden" type="file" id="gidsFile" name="gids_file" accept=".pkl" />
                        <span class="material-symbols-outlined text-slate-400">upload_file</span>
                        <span class="text-xs font-bold lowercase tracking-wider text-slate-500">Spike gids (gids.pkl)</span>
                        <p class="text-[10px] text-slate-400">Default: {{ default_sim_paths.gids }}</p>
                        <p class="text-[10px] text-slate-500" data-filename>Not selected</p>
                        <div class="mt-2 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-[10px] font-semibold px-2 py-1 {% if not default_sim.gids %}hidden{% endif %}"
                            data-uploaded data-default-name="{{ 'gids.pkl' if default_sim.gids else '' }}">
                            <span data-uploaded-label>{% if default_sim.gids %}Loaded{% else %}Uploaded{% endif %}</span>: <span data-uploaded-name>{% if default_sim.gids %}gids.pkl{% endif %}</span>
                        </div>
                    </div>
                    <div id="vmUploadContainer"
                        data-upload="vmFile"
                        class="upload-zone border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-6 flex flex-col items-center justify-center gap-2 cursor-pointer transition-all bg-white dark:bg-slate-900/50">
                        <input class="hidden" type="file" id="vmFile" name="vm_file" accept=".pkl" />
                        <span class="material-symbols-outlined text-slate-400">upload_file</span>
                        <span class="text-xs font-bold lowercase tracking-wider text-slate-500">Membrane Potential (Vm)</span>
                        <p class="text-[10px] text-slate-400">Default: {{ default_sim_paths.vm }}</p>
                        <p class="text-[10px] text-slate-500" data-filename>Not selected</p>
                        <div class="mt-2 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-[10px] font-semibold px-2 py-1 {% if not default_sim.vm %}hidden{% endif %}"
                            data-uploaded data-default-name="{{ 'vm.pkl' if default_sim.vm else '' }}">
                            <span data-uploaded-label>{% if default_sim.vm %}Loaded{% else %}Uploaded{% endif %}</span>: <span data-uploaded-name>{% if default_sim.vm %}vm.pkl{% endif %}</span>
                        </div>
                    </div>
                    <div id="ampaUploadContainer" 
                        data-upload="ampaFile"
                        class="upload-zone border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-6 flex flex-col items-center justify-center gap-2 cursor-pointer transition-all bg-white dark:bg-slate-900/50">
                        <input class="hidden" type="file" id="ampaFile" name="ampa_file" accept=".pkl" />
                        <span class="material-symbols-outlined text-slate-400">upload_file</span>
                        <span class="text-xs font-bold lowercase tracking-wider text-slate-500">AMPA Currents Data</span>
                        <p class="text-[10px] text-slate-400">Default: {{ default_sim_paths.ampa }}</p>
                        <p class="text-[10px] text-slate-500" data-filename>Not selected</p>
                        <div class="mt-2 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-[10px] font-semibold px-2 py-1 {% if not default_sim.ampa %}hidden{% endif %}"
                            data-uploaded data-default-name="{{ 'ampa.pkl' if default_sim.ampa else '' }}">
                            <span data-uploaded-label>{% if default_sim.ampa %}Loaded{% else %}Uploaded{% endif %}</span>: <span data-uploaded-name>{% if default_sim.ampa %}ampa.pkl{% endif %}</span>
                        </div>
                    </div>
                    <div id="gabaUploadContainer" 
                        data-upload="gabaFile"
                        class="upload-zone border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl p-6 flex flex-col items-center justify-center gap-2 cursor-pointer transition-all bg-white dark:bg-slate-900/50">
                        <input class="hidden" type="file" id="gabaFile" name="gaba_file" accept=".pkl" />
                        <span class="material-symbols-outlined text-slate-400">upload_file</span>
                        <span class="text-xs font-bold lowercase tracking-wider text-slate-500">GABA Currents Data</span>
                        <p class="text-[10px] text-slate-400">Default: {{ default_sim_paths.gaba }}</p>
                        <p class="text-[10px] text-slate-500" data-filename>Not selected</p>
                        <div class="mt-2 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-[10px] font-semibold px-2 py-1 {% if not default_sim.gaba %}hidden{% endif %}"
                            data-uploaded data-default-name="{{ 'gaba.pkl' if default_sim.gaba else '' }}">
                            <span data-uploaded-label>{% if default_sim.gaba %}Loaded{% else %}Uploaded{% endif %}</span>: <span data-uploaded-name>{% if default_sim.gaba %}gaba.pkl{% endif %}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- External background rate -->
            <div id="externalRateContainer" class="flex flex-col gap-4">
                <h3 class="text-lg font-bold border-b border-slate-200 dark:border-slate-800 pb-2">External Background Rate</h3>
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex flex-col gap-2 flex-1 w-full">
                        <label class="text-sm font-bold">External Background Rate (nu_ext)</label>
                        <input
                            class="form-input w-full h-12 rounded-lg border-slate-300 dark:border-slate-700 dark:bg-slate-900 focus:ring-primary focus:border-primary"
                            placeholder="e.g., 2.5 or upload file" type="number" step="0.1" name="nu_ext_value" />
                    </div>
                    <div class="w-full md:w-auto">
                        <input class="hidden" type="file" accept=".pkl" id="extBackRateFile" name="nu_ext_file" />
                        <button
                            id="extBackRateButton"
                            class="w-full h-12 px-6 border border-slate-300 dark:border-slate-700 rounded-lg flex items-center justify-center gap-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                            type="button">
                            <span class="material-symbols-outlined text-xl">upload</span>
                            <span class="font-bold text-sm">Upload nu_ext (.pkl)</span>
                        </button>
                        <p class="mt-2 text-[10px] text-slate-400">Default: {{ default_sim_paths.nu_ext }}</p>
                        <p class="text-[10px] text-slate-500" id="extBackRateFilename">Not selected</p>
                        <div class="mt-2 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-[10px] font-semibold px-2 py-1 {% if not default_sim.nu_ext %}hidden{% endif %}"
                            id="extBackRateUploaded" data-default-name="{{ 'nu_ext.pkl' if default_sim.nu_ext else '' }}">
                            <span id="extBackRateUploadedLabel">{% if default_sim.nu_ext %}Loaded{% else %}Uploaded{% endif %}</span>: <span id="extBackRateUploadedName">{% if default_sim.nu_ext %}nu_ext.pkl{% endif %}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div
                class="flex flex-col-reverse sm:flex-row items-center justify-between gap-4 mt-8 pt-8 border-t border-slate-200 dark:border-slate-800">
                <a href="{{url_for('field_potential')}}"
                    class="w-full sm:w-auto px-6 h-12 flex items-center justify-center gap-2 text-slate-600 dark:text-slate-300 font-bold hover:text-slate-900 dark:hover:text-white transition-colors"
                    type="button">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Back to selection
                </a>
                <div class="flex w-full sm:w-auto gap-4">
                    <button
                        class="flex items-center justify-center gap-2 py-2.5 px-5 w-full sm:w-auto bg-primary text-white font-bold text-base rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors"
                        type="submit">
                        Compute proxy
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </button>
                </div>
            </div>
        </form>
        <div class="flex justify-start gap-4 p-4 mt-auto py-10">
            <a href="{{url_for('dashboard')}}" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-6 bg-transparent text-slate-500 dark:text-slate-400 text-sm font-bold leading-normal tracking-[0.015em] border border-slate-200 dark:border-slate-800 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                <span class="truncate">Back to the dashboard</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script defer="" src="{{ url_for('static', filename='js/field_potential_proxy.js') }}"></script>
{% endblock %}
