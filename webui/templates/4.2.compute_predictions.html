{% extends "4.inference.html" %}
{% block title %}Compute predictions{% endblock %}

{% block head %}
{{ super() }}
<style>
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .code-editor::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .code-editor::-webkit-scrollbar-track {
        background: #f1f5f9;
    }
    .code-editor::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }
    .dark .code-editor::-webkit-scrollbar-track {
        background: #1e293b;
    }
    .dark .code-editor::-webkit-scrollbar-thumb {
        background: #475569;
    }
    .loader {
        border-top-color: #39E079;
        -webkit-animation: spinner 1.5s linear infinite;
        animation: spinner 1.5s linear infinite;
    }
    @keyframes spinner {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}


{% block content %}
<div
    x-data="{
        assetsUploadMode: 'individual',
        modelName: '__auto__',
        autoDetectedBackend: '',
        autoDetectedType: '',
        autoDetectError: '',
        autoDetectPending: false,
        autoDetectReady: false,
        setAutoDetection(payload) {
            const detail = payload || {};
            this.autoDetectPending = Boolean(detail.pending);
            this.autoDetectedBackend = (detail.backend || '').toLowerCase();
            this.autoDetectedType = detail.inferred_type || '';
            this.autoDetectError = detail.error || '';
            this.autoDetectReady = Boolean(this.autoDetectedBackend) || Boolean(this.autoDetectError);
        },
        isSbiModel() {
            const selected = this.modelName === '__custom__'
                ? ((this.$refs.customModelName && this.$refs.customModelName.value) ? this.$refs.customModelName.value.trim() : '')
                : this.modelName;
            if (['NPE', 'NLE', 'NRE'].includes(selected)) {
                return true;
            }
            if (selected === '__auto__') {
                return this.autoDetectedBackend === 'sbi';
            }
            return false;
        }
    }"
    @auto-model-detection.window="setAutoDetection($event.detail || null)"
    class="max-w-5xl mx-auto"
>
    <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white mb-2">Compute Predictions</h1>
    <p class="text-slate-600 dark:text-slate-400 mb-8">Generate predictions from your pre-trained machine learning or SBI models.</p>
    <form
        action="{{ url_for('start_computation_redirect', computation_type='inference') }}"
        class="space-y-8"
        enctype="multipart/form-data"
        method="POST"
    >
        <section
            class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <span
                    class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-700 text-sm mr-3 font-bold text-slate-600 dark:text-slate-300">1</span>
                Load Data (Features Data)
            </h2>
            <div class="grid grid-cols-1 gap-6">
                <div>
                    <input id="existing-features-file" type="hidden" name="existing_features_file" value="{{ default_feature_file | default('') }}">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                        Features Data <span class="text-red-500">*</span>
                    </label>
                    <div
                        id="features-loaded-status"
                        class="mb-3 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-sm font-semibold px-3 py-2"
                        {% if not default_feature_file %}style="display:none;"{% endif %}
                    >
                        Loaded:
                        <span id="features-loaded-name">{{ default_feature_file | default('') }}</span>
                        (detected from previous steps)
                    </div>
                    <div
                        onclick="document.getElementById('file-upload-features').click()"
                        class="mt-1 flex justify-center rounded-md border-2 border-dashed border-slate-300 dark:border-slate-600 px-6 pt-5 pb-6 hover:border-primary dark:hover:border-primary transition-colors cursor-pointer bg-slate-50 dark:bg-slate-800/30">
                        <div class="space-y-1 text-center">
                            <span class="material-symbols-outlined text-4xl text-slate-400">upload_file</span>
                            <div class="flex text-sm text-slate-600 dark:text-slate-400 justify-center">
                                <label
                                    class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-hover focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary"
                                    for="file-upload-features">
                                    <span>Upload a file</span>
                                    <input accept=".pkl" class="sr-only" id="file-upload-features"
                                        name="features_predict_file" type="file" />
                                </label>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-500">
                                .pkl only
                            </p>
                        </div>
                    </div>
                    <div
                        id="features-uploaded-status"
                        class="mt-2 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-[10px] font-semibold px-2 py-1"
                        style="display:none;"
                    >
                        Uploaded:
                        <span id="features-uploaded-name"></span>
                    </div>
                    <div
                        id="features-not-loaded-status"
                        class="mt-2 w-full rounded-md bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 text-amber-700 dark:text-amber-300 text-[10px] font-semibold px-2 py-1"
                        {% if default_feature_file %}style="display:none;"{% endif %}
                    >
                        Not loaded: no features dataframe detected from previous steps.
                    </div>
                </div>
            </div>
        </section>
        <section
            class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <span
                    class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-700 text-sm mr-3 font-bold text-slate-600 dark:text-slate-300">2</span>
                Load Prediction Assets
            </h2>
            <div class="grid grid-cols-1 gap-6">
                <input type="hidden" name="model_assets_source" value="upload">
                <input type="hidden" name="assets_upload_mode" :value="assetsUploadMode">

                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Assets Upload Mode</label>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                            <input id="assets-mode-individual" type="radio" class="text-primary focus:ring-primary" x-model="assetsUploadMode" value="individual">
                            Individual files
                        </label>
                        <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300">
                            <input id="assets-mode-folder" type="radio" class="text-primary focus:ring-primary" x-model="assetsUploadMode" value="folder">
                            One folder (all assets)
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" x-show="assetsUploadMode === 'individual'" x-cloak>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="file-upload-model">
                            Model / Posterior <span class="text-red-500">*</span>
                        </label>
                        <div
                            onclick="document.getElementById('file-upload-model').click()"
                            class="mt-1 flex justify-center rounded-md border-2 border-dashed border-slate-300 dark:border-slate-600 px-6 pt-5 pb-6 hover:border-primary dark:hover:border-primary transition-colors cursor-pointer bg-slate-50 dark:bg-slate-800/30">
                            <div class="space-y-1 text-center">
                                <span class="material-symbols-outlined text-4xl text-slate-400">model_training</span>
                                <div class="flex text-sm text-slate-600 dark:text-slate-400 justify-center">
                                    <label
                                        class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-hover focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary"
                                        for="file-upload-model">
                                        <span>Upload model file</span>
                                        <input class="sr-only" id="file-upload-model" name="model_file"
                                            type="file" />
                                    </label>
                                </div>
                                <p class="text-xs text-slate-500 dark:text-slate-500">
                                    model.pkl
                                </p>
                            </div>
                        </div>
                        <div id="asset-model-status"
                            class="mt-2 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-[10px] font-semibold px-2 py-1"
                            style="display:none;">
                            Uploaded: <span id="asset-model-name"></span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                            Scaler Source
                        </label>
                        <div
                            onclick="document.getElementById('file-upload-scaler').click()"
                            class="mt-1 flex justify-center rounded-md border-2 border-dashed border-slate-300 dark:border-slate-600 px-6 pt-5 pb-6 hover:border-primary dark:hover:border-primary transition-colors cursor-pointer bg-slate-50 dark:bg-slate-800/30">
                            <div class="space-y-1 text-center">
                                <span class="material-symbols-outlined text-4xl text-slate-400">scale</span>
                                <div class="flex text-sm text-slate-600 dark:text-slate-400 justify-center">
                                    <label
                                        class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-hover focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary"
                                        for="file-upload-scaler">
                                        <span>Upload scaler</span>
                                        <input class="sr-only" id="file-upload-scaler"
                                            name="scaler_file" type="file" />
                                    </label>
                                </div>
                                <p class="text-xs text-slate-500 dark:text-slate-500">
                                    scaler.pkl
                                </p>
                            </div>
                        </div>
                        <div id="asset-scaler-status"
                            class="mt-2 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-[10px] font-semibold px-2 py-1"
                            style="display:none;">
                            Uploaded: <span id="asset-scaler-name"></span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" x-show="assetsUploadMode === 'individual'" x-cloak>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="file-upload-density-estimator">
                            Density Estimator (optional)
                        </label>
                        <div
                            onclick="document.getElementById('file-upload-density-estimator').click()"
                            class="mt-1 flex justify-center rounded-md border-2 border-dashed border-slate-300 dark:border-slate-600 px-6 pt-5 pb-6 hover:border-primary dark:hover:border-primary transition-colors cursor-pointer bg-slate-50 dark:bg-slate-800/30">
                            <div class="space-y-1 text-center">
                                <span class="material-symbols-outlined text-4xl text-slate-400">deployed_code</span>
                                <div class="flex text-sm text-slate-600 dark:text-slate-400 justify-center">
                                    <label
                                        class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-hover focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary"
                                        for="file-upload-density-estimator">
                                        <span>Upload density_estimator.pkl</span>
                                        <input class="sr-only" id="file-upload-density-estimator"
                                            name="density_estimator_file" type="file" />
                                    </label>
                                </div>
                                <p class="text-xs text-slate-500 dark:text-slate-500">
                                    Needed for SBI when model artifact contains inference object(s)
                                </p>
                            </div>
                        </div>
                        <div id="asset-density-status"
                            class="mt-2 w-full rounded-md bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 text-[10px] font-semibold px-2 py-1"
                            style="display:none;">
                            Uploaded: <span id="asset-density-name"></span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" x-show="assetsUploadMode === 'folder'" x-cloak>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="file-upload-assets-folder">
                            Upload Assets Folder (all at once)
                        </label>
                        <div
                            onclick="document.getElementById('file-upload-assets-folder').click()"
                            class="mt-1 flex justify-center rounded-md border-2 border-dashed border-slate-300 dark:border-slate-600 px-6 pt-5 pb-6 hover:border-primary dark:hover:border-primary transition-colors cursor-pointer bg-slate-50 dark:bg-slate-800/30">
                            <div class="space-y-1 text-center">
                                <span class="material-symbols-outlined text-4xl text-slate-400">folder_open</span>
                                <div class="flex text-sm text-slate-600 dark:text-slate-400 justify-center">
                                    <label
                                        class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-hover focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary"
                                        for="file-upload-assets-folder">
                                        <span>Select folder</span>
                                        <input class="sr-only" id="file-upload-assets-folder"
                                            name="inference_assets_folder" type="file" webkitdirectory directory multiple />
                                    </label>
                                </div>
                                <p class="text-xs text-slate-500 dark:text-slate-500">
                                    Folder can contain model/scaler/density_estimator files
                                </p>
                            </div>
                        </div>
                        <div id="asset-folder-results"
                            class="mt-3 w-full rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-300 dark:border-green-700 text-green-800 dark:text-green-300 px-4 py-3 text-sm"
                            style="display:none;">
                            <div class="font-semibold mb-2">Assets uploaded from folder</div>
                            <div class="space-y-1">
                                <div>Total files: <span id="asset-folder-result-count" class="font-semibold"></span></div>
                                <div>model: <span id="asset-folder-result-model" class="font-semibold"></span></div>
                                <div>scaler: <span id="asset-folder-result-scaler" class="font-semibold"></span></div>
                                <div>density estimator: <span id="asset-folder-result-density" class="font-semibold"></span></div>
                            </div>
                            <div class="mt-3 text-xs font-semibold">Loaded files</div>
                            <ul id="asset-folder-result-files-list" class="mt-1 text-xs font-mono max-h-32 overflow-y-auto space-y-0.5"></ul>
                            <div id="asset-folder-result-files-more" class="text-xs mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section
            class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <span
                    class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-700 text-sm mr-3 font-bold text-slate-600 dark:text-slate-300">3</span>
                Prediction Settings
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="inference-model-name">
                        Inference Model
                    </label>
                    <select
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        id="inference-model-name"
                        name="inference_model_name"
                        x-model="modelName"
                    >
                        <option value="__auto__">Auto (infer from uploaded model file)</option>
                        <optgroup label="Sklearn">
                            <option value="MLPRegressor">MLPRegressor</option>
                            <option value="RandomForestRegressor">RandomForestRegressor</option>
                            <option value="Ridge">Ridge</option>
                            <option value="SVR">SVR</option>
                            <option value="LinearRegression">LinearRegression</option>
                        </optgroup>
                        <optgroup label="SBI">
                            <option value="NPE">NPE</option>
                            <option value="NLE">NLE</option>
                            <option value="NRE">NRE</option>
                        </optgroup>
                        <option value="__custom__">Custom model name...</option>
                    </select>
                    <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Recommended: keep Auto to infer type/backend from uploaded model artifact.</p>
                    <p class="mt-2 text-xs text-slate-500 dark:text-slate-400" x-show="modelName === '__auto__' && autoDetectPending" x-cloak>
                        Auto-detecting backend from uploaded model file...
                    </p>
                    <p class="mt-2 text-xs text-emerald-700 dark:text-emerald-300" x-show="modelName === '__auto__' && !autoDetectPending && autoDetectedBackend" x-cloak>
                        Auto-detected backend: <span class="font-semibold" x-text="autoDetectedBackend"></span>
                        <template x-if="autoDetectedType">
                            <span>(type: <span class="font-semibold" x-text="autoDetectedType"></span>)</span>
                        </template>
                    </p>
                    <p class="mt-2 text-xs text-amber-700 dark:text-amber-300" x-show="modelName === '__auto__' && !autoDetectPending && autoDetectError" x-cloak x-text="autoDetectError"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="inference-model-name-custom">
                        Custom Model Name
                    </label>
                    <input
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        id="inference-model-name-custom"
                        name="inference_model_name_custom"
                        placeholder="e.g., ExtraTreesRegressor"
                        type="text"
                        x-ref="customModelName"
                        :disabled="modelName !== '__custom__'"
                    />
                    <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Used only when "Custom model name..." is selected.</p>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="inline-flex items-center gap-2">
                        <input
                            checked
                            class="rounded border-slate-300 text-primary focus:ring-primary"
                            name="use_scaler"
                            type="checkbox"
                            value="1"
                        />
                        <span class="text-sm text-slate-700 dark:text-slate-300">
                            Apply scaler during prediction when <code>scaler.pkl</code> is available
                        </span>
                    </label>
                </div>
            </div>

            <div class="mt-6">
                <h3 class="text-sm font-semibold text-slate-800 dark:text-slate-200 mb-2">Execution Settings</h3>
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">
                    Parallel prediction settings (applies to sklearn prediction backend).
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label class="text-sm">
                        <span class="block text-xs text-slate-500 dark:text-slate-400 mb-1">Parallel workers (n_jobs)</span>
                        <input
                            type="number"
                            min="1"
                            step="1"
                            name="inference_n_jobs"
                            class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-[#191e33] text-sm text-slate-900 dark:text-white"
                            value="1"
                        />
                    </label>
                    <label class="text-sm">
                        <span class="block text-xs text-slate-500 dark:text-slate-400 mb-1">Chunksize</span>
                        <input
                            type="number"
                            min="1"
                            step="1"
                            name="inference_chunksize"
                            class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-[#191e33] text-sm text-slate-900 dark:text-white"
                            placeholder="Optional"
                        />
                    </label>
                    <label class="text-sm">
                        <span class="block text-xs text-slate-500 dark:text-slate-400 mb-1">Start method</span>
                        <select
                            name="inference_start_method"
                            class="w-full rounded-lg border-slate-300 dark:border-slate-600 bg-background-light dark:bg-[#191e33] text-sm text-slate-900 dark:text-white"
                        >
                            <option value="spawn">spawn</option>
                            <option value="fork">fork</option>
                            <option value="forkserver">forkserver</option>
                        </select>
                    </label>
                </div>
            </div>

            <div class="mt-6">
                <h3 class="text-sm font-semibold text-slate-800 dark:text-slate-200 mb-2">Other Settings (SBI)</h3>
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-4">
                    Optional parameters. If left empty: <code>num_posterior_samples=500</code>, <code>sbi_batch_size=256</code>.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" :class="{ 'opacity-60': !isSbiModel() }">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="sbi-num-posterior-samples">
                        num_posterior_samples (optional)
                    </label>
                    <input
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        id="sbi-num-posterior-samples"
                        min="1"
                        name="sbi_num_posterior_samples"
                        placeholder="500"
                        type="number"
                        :disabled="!isSbiModel()"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="sbi-batch-size">
                        sbi_batch_size (optional)
                    </label>
                    <input
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        id="sbi-batch-size"
                        min="1"
                        name="sbi_batch_size"
                        placeholder="256"
                        type="number"
                        :disabled="!isSbiModel()"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="sbi-summary-mode">
                        SBI Summary Mode
                    </label>
                    <select
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        id="sbi-summary-mode"
                        name="sbi_summary_mode"
                        :disabled="!isSbiModel()"
                    >
                        <option value="mean">Posterior mean</option>
                        <option value="median">Posterior median</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="sbi-build-posterior-kwargs">
                        build_posterior kwargs (JSON)
                    </label>
                    <input
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        id="sbi-build-posterior-kwargs"
                        name="sbi_build_posterior_kwargs"
                        placeholder='{}'
                        type="text"
                        value="{}"
                        :disabled="!isSbiModel()"
                    />
                </div>
            </div>

            <div class="mt-6" x-show="!isSbiModel()" x-cloak>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                    SBI settings are not available for non-SBI models.
                </p>
            </div>
        </section>
        <div class="flex justify-center pt-2">
            <button
                class="flex items-center justify-center px-8 py-4 border border-transparent text-lg font-medium rounded-lg text-white bg-primary hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary shadow-lg transition-all transform hover:scale-105"
                type="submit"
            >
                <span class="material-symbols-outlined mr-2">neurology</span>
                Compute Predictions
            </button>
        </div>
    </form>

    <!-- Navigation buttons -->
    <div class="flex justify-between items-center gap-4 mt-10 pt-6 border-t border-border-light dark:border-[#323b67]">
        <!-- Previous/Return Button -->
        <button>
            <a href="{{ url_for('dashboard') }}"
                class="flex items-center justify-center gap-2 py-2.5 px-5 w-full sm:w-auto text-primary dark:text-white font-bold text-base rounded-lg hover:bg-primary/10 dark:hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors border border-primary dark:border-white/50">
                <span class="material-symbols-outlined">arrow_back</span>
                Return to ncpi dashboard
            </a>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(() => {
    function byId(id) {
        return document.getElementById(id);
    }

    function refreshFeaturesLoadStatus() {
        const input = byId("file-upload-features");
        const existingInput = byId("existing-features-file");
        const loadedStatus = byId("features-loaded-status");
        const uploadedStatus = byId("features-uploaded-status");
        const uploadedName = byId("features-uploaded-name");
        const notLoadedStatus = byId("features-not-loaded-status");

        if (!input || !existingInput || !loadedStatus || !uploadedStatus || !notLoadedStatus) {
            return;
        }

        const file = (input.files && input.files[0]) ? input.files[0] : null;
        const existingName = (existingInput.value || "").trim();

        if (file) {
            uploadedName.textContent = file.name;
            uploadedStatus.style.display = "";
            loadedStatus.style.display = "none";
            notLoadedStatus.style.display = "none";
            existingInput.value = "";
            return;
        }

        uploadedStatus.style.display = "none";
        if (existingName) {
            loadedStatus.style.display = "";
            notLoadedStatus.style.display = "none";
        } else {
            loadedStatus.style.display = "none";
            notLoadedStatus.style.display = "";
        }
    }

    function bindSingleFileStatus(inputId, statusId, nameId) {
        const input = byId(inputId);
        const status = byId(statusId);
        const name = byId(nameId);
        if (!input || !status || !name) return;

        const refresh = () => {
            const file = (input.files && input.files[0]) ? input.files[0] : null;
            if (!file) {
                status.style.display = "none";
                name.textContent = "";
                return;
            }
            name.textContent = file.name;
            status.style.display = "";
        };

        input.addEventListener("change", refresh);
        refresh();
    }

    function bindAssetsFolderStatus() {
        const input = byId("file-upload-assets-folder");
        const resultsBox = byId("asset-folder-results");
        const countEl = byId("asset-folder-result-count");
        const filesList = byId("asset-folder-result-files-list");
        const filesMore = byId("asset-folder-result-files-more");
        const modelEl = byId("asset-folder-result-model");
        const scalerEl = byId("asset-folder-result-scaler");
        const densityEl = byId("asset-folder-result-density");
        if (!input || !resultsBox || !countEl || !filesList || !filesMore || !modelEl || !scalerEl || !densityEl) return;

        const refresh = () => {
            const files = input.files ? Array.from(input.files) : [];
            if (files.length === 0) {
                resultsBox.style.display = "none";
                filesList.innerHTML = "";
                filesMore.textContent = "";
                modelEl.textContent = "";
                scalerEl.textContent = "";
                densityEl.textContent = "";
                return;
            }

            countEl.textContent = String(files.length);
            resultsBox.style.display = "";

            let model = "";
            let scaler = "";
            let density = "";
            for (const f of files) {
                const base = (f.name || "").toLowerCase();
                if (!model && (base.startsWith("model") || base === "model.pkl")) model = f.name;
                if (!scaler && (base.startsWith("scaler") || base === "scaler.pkl")) scaler = f.name;
                if (!density && (base.includes("density_estimator") || base.startsWith("density"))) density = f.name;
            }
            modelEl.textContent = model || "not found";
            scalerEl.textContent = scaler || "not found";
            densityEl.textContent = density || "not found";

            filesList.innerHTML = "";
            const MAX_PREVIEW_FILES = 12;
            const names = files
                .map((f) => (f.webkitRelativePath && f.webkitRelativePath.trim()) ? f.webkitRelativePath : f.name)
                .sort((a, b) => a.localeCompare(b));
            const preview = names.slice(0, MAX_PREVIEW_FILES);
            for (const name of preview) {
                const li = document.createElement("li");
                li.textContent = name;
                filesList.appendChild(li);
            }
            const remaining = names.length - preview.length;
            filesMore.textContent = remaining > 0 ? `...and ${remaining} more file(s)` : "";
        };

        input.addEventListener("change", refresh);
        refresh();
    }

    function bindAssetsModeExclusivity() {
        const individualRadio = byId("assets-mode-individual");
        const folderRadio = byId("assets-mode-folder");
        const modelInput = byId("file-upload-model");
        const scalerInput = byId("file-upload-scaler");
        const densityInput = byId("file-upload-density-estimator");
        const folderInput = byId("file-upload-assets-folder");
        const modelStatus = byId("asset-model-status");
        const scalerStatus = byId("asset-scaler-status");
        const densityStatus = byId("asset-density-status");
        const folderResults = byId("asset-folder-results");
        const folderFilesList = byId("asset-folder-result-files-list");
        const folderFilesMore = byId("asset-folder-result-files-more");
        const folderCount = byId("asset-folder-result-count");
        const folderDetectedModel = byId("asset-folder-result-model");
        const folderDetectedScaler = byId("asset-folder-result-scaler");
        const folderDetectedDensity = byId("asset-folder-result-density");

        if (!individualRadio || !folderRadio || !modelInput || !scalerInput || !densityInput || !folderInput) return;

        const clearIndividual = () => {
            modelInput.value = "";
            scalerInput.value = "";
            densityInput.value = "";
            if (modelStatus) modelStatus.style.display = "none";
            if (scalerStatus) scalerStatus.style.display = "none";
            if (densityStatus) densityStatus.style.display = "none";
        };

        const clearFolder = () => {
            folderInput.value = "";
            if (folderResults) folderResults.style.display = "none";
            if (folderFilesList) folderFilesList.innerHTML = "";
            if (folderFilesMore) folderFilesMore.textContent = "";
            if (folderCount) folderCount.textContent = "";
            if (folderDetectedModel) folderDetectedModel.textContent = "";
            if (folderDetectedScaler) folderDetectedScaler.textContent = "";
            if (folderDetectedDensity) folderDetectedDensity.textContent = "";
        };

        const sync = () => {
            const mode = folderRadio.checked ? "folder" : "individual";
            const individualEnabled = mode === "individual";
            modelInput.disabled = !individualEnabled;
            scalerInput.disabled = !individualEnabled;
            densityInput.disabled = !individualEnabled;
            folderInput.disabled = individualEnabled;
            if (individualEnabled) {
                clearFolder();
            } else {
                clearIndividual();
            }
        };

        individualRadio.addEventListener("change", sync);
        folderRadio.addEventListener("change", sync);
        sync();
    }

    function bindAutoModelDetection() {
        const modelSelect = byId("inference-model-name");
        const modelInput = byId("file-upload-model");
        const folderInput = byId("file-upload-assets-folder");
        const individualRadio = byId("assets-mode-individual");
        const folderRadio = byId("assets-mode-folder");
        if (!modelSelect || !modelInput || !folderInput || !individualRadio || !folderRadio) return;

        const detectUrl = "{{ url_for('inference_detect_model_backend') }}";
        let requestCounter = 0;

        const emit = (detail) => {
            window.dispatchEvent(new CustomEvent("auto-model-detection", { detail: detail || {} }));
        };

        const pickModelFileFromFolder = (files) => {
            const candidates = Array.isArray(files) ? files : [];
            if (!candidates.length) return null;
            for (const file of candidates) {
                const relativePath = (file.webkitRelativePath || file.name || "").toLowerCase();
                const baseName = (file.name || "").toLowerCase();
                if (baseName === "model.pkl" || baseName === "model.pickle") {
                    return file;
                }
                if (relativePath.endsWith("/model.pkl") || relativePath.endsWith("/model.pickle")) {
                    return file;
                }
            }
            for (const file of candidates) {
                const baseName = (file.name || "").toLowerCase();
                if (baseName.startsWith("model") && (baseName.endsWith(".pkl") || baseName.endsWith(".pickle"))) {
                    return file;
                }
            }
            return null;
        };

        const detectFromFile = async (file) => {
            requestCounter += 1;
            const requestId = requestCounter;

            if (!file) {
                emit({});
                return;
            }

            const fileName = (file.name || "").toLowerCase();
            if (!(fileName.endsWith(".pkl") || fileName.endsWith(".pickle"))) {
                emit({ error: "Auto-detection expects a .pkl/.pickle model file." });
                return;
            }

            emit({ pending: true });
            try {
                const formData = new FormData();
                formData.append("model_file", file, file.name || "model.pkl");
                const response = await fetch(detectUrl, {
                    method: "POST",
                    body: formData,
                });
                const payload = await response.json().catch(() => ({}));
                if (requestId !== requestCounter) return;

                if (response.ok && payload && payload.ok && payload.backend) {
                    emit({
                        backend: payload.backend,
                        inferred_type: payload.inferred_type || "",
                    });
                    return;
                }

                emit({
                    error: (payload && payload.error) ? payload.error : "Could not auto-detect model backend.",
                });
            } catch (err) {
                if (requestId !== requestCounter) return;
                emit({ error: (err && err.message) ? err.message : "Could not auto-detect model backend." });
            }
        };

        const refresh = () => {
            if (modelSelect.value !== "__auto__") {
                requestCounter += 1;
                emit({});
                return;
            }

            if (folderRadio.checked) {
                const folderFiles = folderInput.files ? Array.from(folderInput.files) : [];
                const modelFile = pickModelFileFromFolder(folderFiles);
                if (!modelFile) {
                    emit({});
                    return;
                }
                detectFromFile(modelFile);
                return;
            }

            const selectedModelFile = (modelInput.files && modelInput.files[0]) ? modelInput.files[0] : null;
            if (!selectedModelFile) {
                emit({});
                return;
            }
            detectFromFile(selectedModelFile);
        };

        modelSelect.addEventListener("change", refresh);
        modelInput.addEventListener("change", refresh);
        folderInput.addEventListener("change", refresh);
        individualRadio.addEventListener("change", refresh);
        folderRadio.addEventListener("change", refresh);
        refresh();
    }

    window.handleInferenceFeaturesInputChange = refreshFeaturesLoadStatus;

    document.addEventListener("DOMContentLoaded", () => {
        const input = byId("file-upload-features");
        if (input && !input.dataset.ncpiFeaturesBound) {
            input.addEventListener("change", refreshFeaturesLoadStatus);
            input.dataset.ncpiFeaturesBound = "1";
        }
        bindSingleFileStatus("file-upload-model", "asset-model-status", "asset-model-name");
        bindSingleFileStatus("file-upload-scaler", "asset-scaler-status", "asset-scaler-name");
        bindSingleFileStatus("file-upload-density-estimator", "asset-density-status", "asset-density-name");
        bindAssetsFolderStatus();
        bindAssetsModeExclusivity();
        bindAutoModelDetection();
        refreshFeaturesLoadStatus();
    });
})();
</script>
{% endblock %}
