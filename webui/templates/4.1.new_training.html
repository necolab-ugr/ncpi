{% extends "4.inference.html" %}
{% block title %}New training{% endblock %}

{% block head %}
{{ super() }}
<style>
    [x-cloak] {
        display: none !important;
    }
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .code-editor::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .code-editor::-webkit-scrollbar-track {
        background: #f1f5f9;
    }
    .code-editor::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }
    .dark .code-editor::-webkit-scrollbar-track {
        background: #1e293b;
    }
    .dark .code-editor::-webkit-scrollbar-thumb {
        background: #475569;
    }
</style>
{% endblock %}

{% block content %}
<div
    x-data="{
        modelName: 'MLPRegressor',
        cvEnabled: false,
        paramGridEnabled: false,
        uploads: {},
        isUploaded(id) { return this.uploads[id]?.uploaded === true; },
        getFileName(id) { return this.uploads[id]?.name || ''; },
        onFileSelected(event, id) {
            const input = event && event.target ? event.target : null;
            const file = input && input.files && input.files[0] ? input.files[0] : null;
            if (!file) {
                this.uploads[id] = { uploaded: false, name: '' };
                return;
            }
            this.uploads[id] = { uploaded: true, name: file.name };
        },
        isSbiModel() {
            const selected = this.modelName === '__custom__'
                ? ((this.$refs.customModelName && this.$refs.customModelName.value) ? this.$refs.customModelName.value.trim() : '')
                : this.modelName;
            return ['NPE', 'NLE', 'NRE'].includes(selected);
        }
    }"
    class="max-w-5xl mx-auto"
>
    <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white mb-2">Inference Training Configuration</h1>
    <p class="text-slate-600 dark:text-slate-400 mb-8">Configure training and launch a model-training job from uploaded features and parameters.</p>

    <form action="{{ url_for('start_computation_redirect', computation_type='inference_training') }}" method="POST" enctype="multipart/form-data" class="space-y-8">
        <section class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-700 text-sm mr-3 font-bold text-slate-600 dark:text-slate-300">A</span>
                Dataset Upload
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                        Features Data <span class="text-red-500">*</span>
                    </label>
                    <div onclick="document.getElementById('training-features-file').click()"
                        class="mt-1 flex justify-center rounded-md border-2 border-dashed border-slate-300 dark:border-slate-600 px-6 pt-5 pb-6 hover:border-primary dark:hover:border-primary transition-colors cursor-pointer bg-slate-50 dark:bg-slate-800/30">
                        <div class="space-y-1 text-center">
                            <span class="material-symbols-outlined text-4xl text-slate-400">upload_file</span>
                            <div class="flex text-sm text-slate-600 dark:text-slate-400 justify-center">
                                <label class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-hover focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary"
                                    for="training-features-file">
                                    <span>Upload a file</span>
                                    <input class="sr-only" id="training-features-file" name="training_features_file" type="file" @change="onFileSelected($event, 'training-features-file')" />
                                </label>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-500">Any supported dataframe format</p>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Features matrix/dataframe (X). If dataframe contains <code>Features</code>, it will be used directly.</p>
                    <div x-show="isUploaded('training-features-file')" class="mt-4 p-3 bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 text-sm font-medium rounded-lg flex items-center gap-2">
                        <span class="material-symbols-outlined">check_circle</span>
                        <span>File uploaded successfully</span>
                        <span class="font-semibold">(<span x-text="getFileName('training-features-file')"></span>)</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                        Parameters Data <span class="text-red-500">*</span>
                    </label>
                    <div onclick="document.getElementById('training-parameters-file').click()"
                        class="mt-1 flex justify-center rounded-md border-2 border-dashed border-slate-300 dark:border-slate-600 px-6 pt-5 pb-6 hover:border-primary dark:hover:border-primary transition-colors cursor-pointer bg-slate-50 dark:bg-slate-800/30">
                        <div class="space-y-1 text-center">
                            <span class="material-symbols-outlined text-4xl text-slate-400">table_chart</span>
                            <div class="flex text-sm text-slate-600 dark:text-slate-400 justify-center">
                                <label class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-hover focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary"
                                    for="training-parameters-file">
                                    <span>Upload a file</span>
                                    <input class="sr-only" id="training-parameters-file" name="training_parameters_file" type="file" @change="onFileSelected($event, 'training-parameters-file')" />
                                </label>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-500">Any supported dataframe format</p>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Target parameters matrix/vector (Y, Î¸).</p>
                    <div x-show="isUploaded('training-parameters-file')" class="mt-4 p-3 bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 text-sm font-medium rounded-lg flex items-center gap-2">
                        <span class="material-symbols-outlined">check_circle</span>
                        <span>File uploaded successfully</span>
                        <span class="font-semibold">(<span x-text="getFileName('training-parameters-file')"></span>)</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-700 text-sm mr-3 font-bold text-slate-600 dark:text-slate-300">B</span>
                Core Setup
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-model-name">Model</label>
                    <select
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        id="training-model-name"
                        name="training_model_name"
                        x-model="modelName"
                    >
                        <optgroup label="Sklearn">
                            <option value="MLPRegressor">MLPRegressor</option>
                            <option value="RandomForestRegressor">RandomForestRegressor</option>
                            <option value="Ridge">Ridge</option>
                            <option value="SVR">SVR</option>
                            <option value="LinearRegression">LinearRegression</option>
                        </optgroup>
                        <optgroup label="SBI">
                            <option value="NPE">NPE</option>
                            <option value="NLE">NLE</option>
                            <option value="NRE">NRE</option>
                        </optgroup>
                        <option value="__custom__">Custom model name...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-model-name-custom">Custom Model Name</label>
                    <input
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        id="training-model-name-custom"
                        name="training_model_name_custom"
                        type="text"
                        placeholder="e.g., ExtraTreesRegressor"
                        x-ref="customModelName"
                        :disabled="modelName !== '__custom__'"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-seed">Random Seed</label>
                    <input
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        id="training-seed"
                        name="training_seed"
                        type="number"
                        value="0"
                    />
                </div>
                <div class="flex items-center pt-6">
                    <label class="inline-flex items-center gap-2">
                        <input class="rounded border-slate-300 text-primary focus:ring-primary" name="training_use_scaler" type="checkbox" value="1" />
                        <span class="text-sm text-slate-700 dark:text-slate-300">Scale input features during training</span>
                    </label>
                </div>
            </div>
        </section>

        <section class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-700 text-sm mr-3 font-bold text-slate-600 dark:text-slate-300">C</span>
                Training Strategy
            </h2>

            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="training-hyperparams-json">Base Hyperparameters (dict)</label>
                    <textarea
                        id="training-hyperparams-json"
                        name="training_hyperparams_json"
                        rows="3"
                        class="code-editor block w-full rounded-md border-slate-300 dark:border-slate-600 font-mono text-sm bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-300 focus:border-primary focus:ring-primary"
                    >{}</textarea>
                </div>

                <div class="flex items-center">
                    <label class="inline-flex items-center gap-2">
                        <input class="rounded border-slate-300 text-primary focus:ring-primary" type="checkbox" name="training_enable_cv" value="1" x-model="cvEnabled" />
                        <span class="text-sm text-slate-700 dark:text-slate-300">Enable cross-validation / repeated CV</span>
                    </label>
                </div>
                <p class="text-xs text-slate-500 dark:text-slate-400" x-show="!cvEnabled">
                    Direct training mode: model is trained once on the full (or subsampled) dataset without CV.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" x-show="cvEnabled" x-cloak>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-n-splits">CV Splits (n_splits)</label>
                        <input
                            id="training-n-splits"
                            name="training_n_splits"
                            type="number"
                            min="2"
                            value="10"
                            class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-n-repeats">CV Repeats (n_repeats)</label>
                        <input
                            id="training-n-repeats"
                            name="training_n_repeats"
                            type="number"
                            min="1"
                            value="10"
                            class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                        />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-subsample-percent">Random Subsample (%)</label>
                    <input
                        id="training-subsample-percent"
                        name="training_subsample_percent"
                        type="number"
                        min="0.1"
                        max="100"
                        step="0.1"
                        placeholder="100 (default)"
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                    />
                    <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Randomly samples this percentage of rows before training.</p>
                </div>

                <div class="flex items-center">
                    <label class="inline-flex items-center gap-2">
                        <input class="rounded border-slate-300 text-primary focus:ring-primary" type="checkbox" name="training_enable_param_grid" value="1" x-model="paramGridEnabled" :disabled="!cvEnabled" />
                        <span class="text-sm text-slate-700 dark:text-slate-300">Enable hyperparameter search (param_grid)</span>
                    </label>
                </div>
                <div x-show="cvEnabled && paramGridEnabled" x-cloak>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="training-param-grid-json">Parameter Grid (dict of lists or list of dicts)</label>
                    <textarea
                        id="training-param-grid-json"
                        name="training_param_grid_json"
                        rows="4"
                        class="code-editor block w-full rounded-md border-slate-300 dark:border-slate-600 font-mono text-sm bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-300 focus:border-primary focus:ring-primary"
                        placeholder="e.g. {'n_estimators': [100, 300], 'max_depth': [5, 10]}"
                    ></textarea>
                </div>
            </div>
        </section>

        <section class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700" x-show="isSbiModel()" x-cloak>
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                <span class="flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-700 text-sm mr-3 font-bold text-slate-600 dark:text-slate-300">D</span>
                SBI Settings
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-sbi-prior-low">Prior Low</label>
                    <input
                        id="training-sbi-prior-low"
                        name="training_sbi_prior_low"
                        type="text"
                        placeholder="0 or [0, 0, 0]"
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-sbi-prior-high">Prior High</label>
                    <input
                        id="training-sbi-prior-high"
                        name="training_sbi_prior_high"
                        type="text"
                        placeholder="1 or [1, 1, 1]"
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                    />
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-sbi-estimator">Estimator</label>
                    <select
                        id="training-sbi-estimator"
                        name="training_sbi_estimator"
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                    >
                        <option value="nsf">nsf</option>
                        <option value="maf">maf</option>
                        <option value="mdn">mdn</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-sbi-eval-num">CV Posterior Samples</label>
                    <input
                        id="training-sbi-eval-num"
                        name="training_sbi_eval_num_posterior_samples"
                        type="number"
                        min="1"
                        value="2000"
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="training-sbi-eval-batch">CV Eval Batch Size</label>
                    <input
                        id="training-sbi-eval-batch"
                        name="training_sbi_eval_batch_size"
                        type="number"
                        min="1"
                        value="256"
                        class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white"
                    />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="training-sbi-estimator-kwargs">Estimator kwargs (dict)</label>
                    <textarea
                        id="training-sbi-estimator-kwargs"
                        name="training_sbi_estimator_kwargs_json"
                        rows="2"
                        class="code-editor block w-full rounded-md border-slate-300 dark:border-slate-600 font-mono text-sm bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-300 focus:border-primary focus:ring-primary"
                    >{}</textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="training-sbi-inference-kwargs">Inference kwargs (dict)</label>
                    <textarea
                        id="training-sbi-inference-kwargs"
                        name="training_sbi_inference_kwargs_json"
                        rows="2"
                        class="code-editor block w-full rounded-md border-slate-300 dark:border-slate-600 font-mono text-sm bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-300 focus:border-primary focus:ring-primary"
                    >{}</textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="training-sbi-build-posterior-kwargs">build_posterior kwargs (dict)</label>
                    <textarea
                        id="training-sbi-build-posterior-kwargs"
                        name="training_sbi_build_posterior_kwargs_json"
                        rows="2"
                        class="code-editor block w-full rounded-md border-slate-300 dark:border-slate-600 font-mono text-sm bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-300 focus:border-primary focus:ring-primary"
                    >{}</textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="training-sbi-train-params">SBI train params (dict)</label>
                    <textarea
                        id="training-sbi-train-params"
                        name="training_sbi_train_params_json"
                        rows="2"
                        class="code-editor block w-full rounded-md border-slate-300 dark:border-slate-600 font-mono text-sm bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-300 focus:border-primary focus:ring-primary"
                    >{"max_num_epochs": 50}</textarea>
                </div>
            </div>
        </section>

        <div class="flex justify-between items-center gap-4 mt-10 pt-6 border-t border-border-light dark:border-[#323b67]">
            <a href="{{ url_for('inference') }}"
                class="flex items-center justify-center gap-2 py-2.5 px-5 w-full sm:w-auto text-primary dark:text-white font-bold text-base rounded-lg hover:bg-primary/10 dark:hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors border border-primary dark:border-white/50">
                <span class="material-symbols-outlined">arrow_back</span>
                Back to Inference
            </a>
            <button type="submit"
                class="flex items-center justify-center gap-2 py-2.5 px-6 w-full sm:w-auto bg-primary text-white font-bold text-base rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors">
                Start Training
                <span class="material-symbols-outlined">play_arrow</span>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{% endblock %}
