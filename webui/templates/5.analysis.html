{% extends "base.html" %}
{% block title %}Analysis{% endblock %}

<!-- Main color for simulation page: purple -->
{% block head %}
{{ super() }}

<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#2C097F",
                    "primary-dark": "#A78BFA", // Lighter purple for dark mode
                    "background-light": "#f6f6f8",
                    "background-dark": "#101322",
                },
                fontFamily: {
                    "display": ["Space Grotesk"]
                },
                borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" }
            }
        }
    };
</script>
<script>
    window.__analysisDataFiles = {{ analysis_data_files | tojson }};
    window.__featureDataFiles = {{ feature_data_files | tojson }};
</script>
<style>
    body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
</style>

{% endblock %}



{% block content %}
<div x-data="{
            activeTab: 'upload-data',
            tabOrder: ['upload-data', 'boxplot', 'topomap'],
            uploads: {},
            dfColumns: [],
            columnsLoading: false,
            columnsError: '',
            uploadInProgress: false,
            uploadProgress: 0,
            uploadTotal: 0,
            uploadLoaded: 0,
            boxplotGroupBy: '',
            boxplotValueCol: '',
            boxplotShowCohen: false,
            boxplotControlGroup: '',
            boxplotGroupValues: [],
            boxplotGroupValuesLoading: false,
            boxplotGroupValuesError: '',
            boxplotLastGroupColumn: '',
            topomapControlGroup: '',
            topomapGroupValues: [],
            topomapGroupValuesLoading: false,
            topomapGroupValuesError: '',
            topomapLastGroupColumn: '',
            topomapGroupBy: '',
            topomapValueCol: '',
            topomapMode: 'per_sensor',
            hasExistingData: {{ 'true' if has_analysis_data else 'false' }},
            existingDataFiles: (window.__analysisDataFiles || []),
            featureDataFiles: (window.__featureDataFiles || []),
            isUploaded(id) { return this.uploads[id]?.uploaded === true; },
            getFileName(id) { return this.uploads[id]?.name || ''; },
            currentDataFile() { return this.existingDataFiles.length ? this.existingDataFiles[0] : ''; },
            nextTab() {
                const idx = this.tabOrder.indexOf(this.activeTab);
                if (idx >= 0 && idx < this.tabOrder.length - 1) {
                    this.activeTab = this.tabOrder[idx + 1];
                }
            },
            prevTab() {
                const idx = this.tabOrder.indexOf(this.activeTab);
                if (idx > 0) {
                    this.activeTab = this.tabOrder[idx - 1];
                }
            },
            init() {
                if (this.hasExistingData) {
                    const name = this.currentDataFile();
                    if (name) {
                        this.uploads['dataframe-upload'] = { name: name, uploaded: true, persisted: true };
                    }
                    this.loadColumnsFromServer();
                }
            },
            onFileSelected(file, inputId) {
                if (inputId !== 'dataframe-upload') {
                    return;
                }
                this.loadColumns(file);
            },
            async fetchGroupValues(column, target) {
                if (!column || !this.hasExistingData) {
                    if (target === 'boxplot') {
                        this.boxplotGroupValues = [];
                        this.boxplotGroupValuesError = '';
                        this.boxplotControlGroup = '';
                        this.boxplotLastGroupColumn = '';
                    } else {
                        this.topomapGroupValues = [];
                        this.topomapGroupValuesError = '';
                        this.topomapControlGroup = '';
                        this.topomapLastGroupColumn = '';
                    }
                    return;
                }
                const targetKey = target === 'boxplot' ? 'boxplot' : 'topomap';
                const lastKey = `${targetKey}LastGroupColumn`;
                if (this[lastKey] === column) {
                    return;
                }
                this[lastKey] = column;
                const valuesKey = `${targetKey}GroupValues`;
                const loadingKey = `${targetKey}GroupValuesLoading`;
                const errorKey = `${targetKey}GroupValuesError`;
                this[loadingKey] = true;
                this[errorKey] = '';
                this[valuesKey] = [];
                try {
                    const response = await fetch(`{{ url_for("analysis_column_values") }}?column=${encodeURIComponent(column)}`);
                    const data = await response.json();
                    if (!response.ok || data.error) {
                        throw new Error(data.error || 'Failed to load group values.');
                    }
                    this[valuesKey] = Array.isArray(data.values) ? data.values : [];
                    if (targetKey === 'boxplot' && this.boxplotControlGroup && !this.boxplotGroupValues.includes(this.boxplotControlGroup)) {
                        this.boxplotControlGroup = '';
                    }
                    if (targetKey === 'topomap' && this.topomapControlGroup && !this.topomapGroupValues.includes(this.topomapControlGroup)) {
                        this.topomapControlGroup = '';
                    }
                } catch (err) {
                    const message = err && err.message ? err.message : 'Failed to load group values.';
                    this[errorKey] = message;
                } finally {
                    this[loadingKey] = false;
                }
            },
            handleFileDrop(event) {
                const file = event.dataTransfer && event.dataTransfer.files ? event.dataTransfer.files[0] : null;
                if (!file) {
                    return;
                }
                const inputId = 'dataframe-upload';
                if (!this.uploads) {
                    this.uploads = {};
                }
                this.uploads[inputId] = { name: file.name, uploaded: false };
                if (typeof this.onFileSelected === 'function') {
                    this.onFileSelected(file, inputId);
                }
                if (this.$nextTick) {
                    this.$nextTick();
                }
            },
            formatBytes(bytes) {
                if (!bytes && bytes !== 0) {
                    return '';
                }
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let value = bytes;
                let unitIndex = 0;
                while (value >= 1024 && unitIndex < units.length - 1) {
                    value /= 1024;
                    unitIndex += 1;
                }
                const precision = value >= 10 || unitIndex === 0 ? 0 : 1;
                return `${value.toFixed(precision)} ${units[unitIndex]}`;
            },
            async loadColumnsFromServer() {
                this.columnsError = '';
                this.dfColumns = [];
                this.columnsLoading = true;
                try {
                    const response = await fetch('{{ url_for("analysis_columns_current") }}');
                    const data = await response.json();
                    if (!response.ok || data.error) {
                        throw new Error(data.error || 'Failed to load columns.');
                    }
                    this.dfColumns = Array.isArray(data.columns) ? data.columns : [];
                } catch (err) {
                    const message = err && err.message ? err.message : 'Failed to load columns.';
                    this.columnsError = message;
                } finally {
                    this.columnsLoading = false;
                }
            },
            async loadColumns(file) {
                this.columnsError = '';
                this.dfColumns = [];
                this.columnsLoading = true;
                this.boxplotGroupValues = [];
                this.topomapGroupValues = [];
                this.boxplotControlGroup = '';
                this.topomapControlGroup = '';
                this.uploadInProgress = true;
                this.uploadProgress = 0;
                this.uploadTotal = file && file.size ? file.size : 0;
                this.uploadLoaded = 0;

                try {
                    const formData = new FormData();
                    formData.append('dataframe', file);
                    const data = await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', '{{ url_for("analysis_columns") }}', true);
                        xhr.responseType = 'json';
                        xhr.upload.addEventListener('progress', (evt) => {
                            if (!evt.lengthComputable) {
                                return;
                            }
                            this.uploadTotal = evt.total;
                            this.uploadLoaded = evt.loaded;
                            const percent = Math.round((evt.loaded / evt.total) * 100);
                            this.uploadProgress = Math.min(100, Math.max(0, percent));
                        });
                        xhr.addEventListener('load', () => {
                            const responseData = xhr.response || {};
                            if (xhr.status >= 200 && xhr.status < 300 && !responseData.error) {
                                this.uploadProgress = 100;
                                resolve(responseData);
                                return;
                            }
                            const errorMessage = responseData.error || 'Failed to load columns.';
                            reject(new Error(errorMessage));
                        });
                        xhr.addEventListener('error', () => reject(new Error('Network error while uploading.')));
                        xhr.addEventListener('abort', () => reject(new Error('Upload canceled.')));
                        xhr.send(formData);
                    });

                    this.dfColumns = Array.isArray(data.columns) ? data.columns : [];
                    this.existingDataFiles = [file.name];
                    this.hasExistingData = true;
                    if (!this.uploads['dataframe-upload']) {
                        this.uploads['dataframe-upload'] = { name: file.name, uploaded: true };
                    } else {
                        this.uploads['dataframe-upload'].uploaded = true;
                    }
                } catch (err) {
                    const message = err && err.message ? err.message : 'Failed to load columns.';
                    this.columnsError = message;
                } finally {
                    this.columnsLoading = false;
                    this.uploadInProgress = false;
                }
            },
            async useDetectedFeaturesFile(filename) {
                if (!filename) {
                    return;
                }
                this.columnsError = '';
                this.columnsLoading = true;
                this.boxplotGroupValues = [];
                this.topomapGroupValues = [];
                this.boxplotControlGroup = '';
                this.topomapControlGroup = '';
                try {
                    const formData = new FormData();
                    formData.append('features_file', filename);
                    const response = await fetch('{{ url_for("analysis_select_features_file") }}', {
                        method: 'POST',
                        body: formData,
                    });
                    const data = await response.json();
                    if (!response.ok || data.error) {
                        throw new Error(data.error || 'Failed to load detected features file.');
                    }
                    this.dfColumns = Array.isArray(data.columns) ? data.columns : [];
                    const selected = data.filename || filename;
                    this.existingDataFiles = [selected];
                    this.hasExistingData = true;
                    this.uploads['dataframe-upload'] = { name: selected, uploaded: true, persisted: true };
                } catch (err) {
                    const message = err && err.message ? err.message : 'Failed to load detected features file.';
                    this.columnsError = message;
                } finally {
                    this.columnsLoading = false;
                }
            }
        }" x-init="init()">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white">Analysis Module Configuration
        </h1>
        <p class="mt-2 text-slate-600 dark:text-slate-400">Select your data frame and configure the plotting and analysis parameters.</p>

        <!-- Menu tabs -->
        <div class="mt-8 border-b border-slate-200 dark:border-slate-700">
            <nav aria-label="Tabs" class="-mb-px flex space-x-8">
                <button @click="activeTab = 'upload-data'" type="button"
                    :class="{ 'border-primary text-primary dark:text-primary-dark dark:border-primary-dark': activeTab === 'upload-data', 'border-transparent text-gray-500 dark:text-white/70 hover:text-gray-700 dark:hover:text-white': activeTab !== 'upload-data' }"
                    class="shrink-0 border-b-2 px-1 pb-4 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-500 transition-colors">
                    Load data</button>
                <button @click="activeTab = 'boxplot'" type="button"
                    :class="{ 'border-primary text-primary dark:text-primary-dark dark:border-primary-dark': activeTab === 'boxplot', 'border-transparent text-gray-500 dark:text-white/70 hover:text-gray-700 dark:hover:text-white': activeTab !== 'boxplot' }"
                    class="shrink-0 border-b-2 px-1 pb-4 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-500 transition-colors">
                    Boxplot</button>
                <button @click="activeTab = 'topomap'" type="button"
                    :class="{ 'border-primary text-primary dark:text-primary-dark dark:border-primary-dark': activeTab === 'topomap', 'border-transparent text-gray-500 dark:text-white/70 hover:text-gray-700 dark:hover:text-white': activeTab !== 'topomap' }"
                    class="shrink-0 border-b-2 px-1 pb-4 text-sm font-medium hover:border-gray-300 dark:hover:border-gray-500 transition-colors">
                    Topomap</button>
            </nav>
        </div>

        <!-- Form action -->
        <form action="{{ url_for('start_computation_redirect', computation_type='analysis')}} " method="POST" enctype="multipart/form-data">
            <!-- Tab contents -->
            <div class="mt-12 space-y-8">
                <!-- Load Data Tab -->
                <div x-show="activeTab === 'upload-data'" x-cloak>
                    <section
                        class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Upload dataframe (.pkl)</h3>
                        <div x-show="hasExistingData" class="mt-3 rounded-md border border-emerald-200 dark:border-emerald-800/50 bg-emerald-50/70 dark:bg-emerald-900/30 px-4 py-3 text-sm text-emerald-800 dark:text-emerald-200 flex flex-wrap items-center gap-3">
                            <span class="font-semibold">Current dataframe:</span>
                            <span x-text="currentDataFile()"></span>
                            <form action="{{ url_for('clear_analysis_data') }}" method="POST">
                                <button type="submit"
                                    class="text-xs font-semibold uppercase tracking-wider text-red-600 dark:text-red-400 border border-red-200 dark:border-red-700/60 rounded-md px-2 py-1 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                                    Clear data
                                </button>
                            </form>
                        </div>
                        <div x-show="featureDataFiles.length" class="mt-4 rounded-md border border-sky-200 dark:border-sky-800/50 bg-sky-50/70 dark:bg-sky-900/20 px-4 py-3">
                            <p class="text-sm font-semibold text-sky-900 dark:text-sky-200">Detected feature files in tmp</p>
                            <p class="mt-1 text-xs text-sky-700 dark:text-sky-300">Select one to use directly in Analysis.</p>
                            <div class="mt-3 flex flex-wrap gap-2">
                                <template x-for="name in featureDataFiles" :key="`feature-${name}`">
                                    <button type="button"
                                        @click="useDetectedFeaturesFile(name)"
                                        class="inline-flex items-center gap-1 rounded-md border border-sky-300 dark:border-sky-700 px-2.5 py-1.5 text-xs font-medium text-sky-800 dark:text-sky-200 hover:bg-sky-100 dark:hover:bg-sky-900/40 transition-colors">
                                        <span class="material-symbols-outlined text-sm">dataset</span>
                                        <span x-text="name"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                        <div
                            class="mt-4 flex justify-center rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 px-6 py-10"
                            @dragenter.prevent
                            @dragover.prevent
                            @drop.prevent="handleFileDrop($event)">
                            <div class="text-center">
                                <span class="material-icons text-4xl text-slate-400 mx-auto">upload_file</span>
                                <div class="mt-4 flex text-sm leading-6 text-slate-600 dark:text-slate-400">
                                    <label
                                        class="relative cursor-pointer rounded-md bg-white dark:bg-transparent font-semibold text-primary focus-within:outline-none focus-within:ring-2 focus-within:ring-primary focus-within:ring-offset-2 dark:focus-within:ring-offset-slate-900 hover:text-indigo-500 dark:text-primary-dark"
                                        for="dataframe-upload">
                                        <span>Drag &amp; drop your .pkl file here</span>
                                        <input class="sr-only" id="dataframe-upload" name="dataframe" type="file"
                                            accept=".pkl,.pickle" @change="handleFileUpload($event)" />
                                    </label>
                                </div>
                                <p class="text-xs leading-5 text-slate-500 dark:text-slate-500">or</p>
                                <button @click="document.getElementById('dataframe-upload').click()"
                                    class="mt-2 rounded-md bg-white dark:bg-slate-700/50 px-2.5 py-1.5 text-sm font-semibold text-slate-900 dark:text-slate-200 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700"
                                    type="button">Browse file</button>
                            </div>
                        </div>
                        <div x-show="uploadInProgress" class="mt-4">
                            <div class="flex items-center justify-between text-xs text-slate-600 dark:text-slate-400">
                                <span>Uploading...</span>
                                <span x-text="`${uploadProgress}%`"></span>
                            </div>
                            <div class="mt-2 h-2 w-full rounded-full bg-slate-200 dark:bg-slate-700">
                                <div class="h-2 rounded-full bg-primary transition-all duration-200"
                                    :style="`width: ${uploadProgress}%`"></div>
                            </div>
                            <div x-show="uploadTotal" class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                                <span x-text="formatBytes(uploadLoaded)"></span>
                                <span>/</span>
                                <span x-text="formatBytes(uploadTotal)"></span>
                            </div>
                        </div>
                        <p class="mt-2 text-xs text-slate-500 dark:text-slate-500">Supported format: .pkl/.pickle only.</p>
                        <!-- Upload status indicator -->
                        <div x-show="isUploaded('dataframe-upload')" class="mt-4 p-3 bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 text-sm font-medium rounded-lg flex items-center gap-2">
                            <span class="material-symbols-outlined">check_circle</span>
                            <span>Data uploaded successfully</span>
                            <span x-show="getFileName('dataframe-upload')" class="font-semibold">(<span x-text="getFileName('dataframe-upload')"></span>)</span>
                        </div>
                    </section>

                    <section
                        class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Detected columns</h3>
                        <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Column names are extracted from the uploaded dataframe.</p>

                        <div class="mt-4">
                            <div x-show="columnsLoading" class="text-sm text-slate-500 dark:text-slate-400">Loading columns...</div>
                            <div x-show="columnsError" class="text-sm text-red-600 dark:text-red-400" x-text="columnsError"></div>

                            <div x-show="!columnsLoading && !columnsError && !dfColumns.length" class="text-sm text-slate-500 dark:text-slate-400">Upload a dataframe to populate the variable list.</div>

                            <div x-show="dfColumns.length" class="flex flex-wrap gap-2">
                                <template x-for="col in dfColumns" :key="col">
                                    <span class="inline-flex items-center rounded-full bg-slate-100 dark:bg-slate-700/60 px-2.5 py-1 text-xs font-medium text-slate-700 dark:text-slate-200" x-text="col"></span>
                                </template>
                            </div>
                            <div x-show="dfColumns.length" class="mt-3 text-xs text-slate-500 dark:text-slate-400">Columns found: <span x-text="dfColumns.length"></span></div>
                        </div>
                    </section>
                </div>

                <!-- Boxplot configuration -->
                <div x-show="activeTab === 'boxplot'" class="mt-12 space-y-8" x-cloak>
                    <section
                        class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                        <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Boxplot configuration</h2>
                        <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Configure the grouping factor used on the x-axis.</p>
                        <div class="mt-6 border-t border-slate-200 dark:border-slate-700 pt-6">
                            <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                                <div class="sm:col-span-3">
                                    <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-300"
                                        for="boxplot-group-by">X-axis grouping factor</label>
                                    <div class="mt-2">
                                        <select
                                            class="block w-full rounded-md border-0 py-1.5 text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm sm:leading-6"
                                            id="boxplot-group-by" name="boxplot_group_by" x-model="boxplotGroupBy"
                                            x-effect="fetchGroupValues(boxplotGroupBy, 'boxplot')"
                                            :disabled="!dfColumns.length || columnsLoading">
                                            <option value="" disabled selected>Select a column</option>
                                            <template x-for="col in dfColumns" :key="col">
                                                <option :value="col" x-text="col"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <p x-show="columnsLoading" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Loading columns...</p>
                                    <p x-show="!columnsLoading && !dfColumns.length" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Upload a dataframe to enable column selection.</p>
                                </div>
                                <div class="sm:col-span-3">
                                    <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-300"
                                        for="boxplot-value-col">Y-axis variable</label>
                                    <div class="mt-2">
                                        <select
                                            class="block w-full rounded-md border-0 py-1.5 text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm sm:leading-6"
                                            id="boxplot-value-col" name="boxplot_value_col" x-model="boxplotValueCol"
                                            :disabled="!dfColumns.length || columnsLoading">
                                            <option value="" disabled selected>Select a column</option>
                                            <template x-for="col in dfColumns" :key="col">
                                                <option :value="col" x-text="col"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <p x-show="columnsLoading" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Loading columns...</p>
                                    <p x-show="!columnsLoading && !dfColumns.length" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Upload a dataframe to enable column selection.</p>
                                </div>
                                <div class="sm:col-span-6">
                                    <div class="mt-2 rounded-lg border border-slate-200 dark:border-slate-700 p-4">
                                        <h4 class="text-sm font-semibold text-slate-900 dark:text-slate-200">Boxplot options</h4>
                                        <div class="mt-4 grid grid-cols-1 gap-x-6 gap-y-4 sm:grid-cols-6">
                                            <div class="sm:col-span-2">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-showfliers">Show fliers</label>
                                                <div class="mt-2 flex items-center gap-2">
                                                    <input id="boxplot-showfliers" name="boxplot_showfliers" type="checkbox"
                                                        class="h-4 w-4 rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary dark:checked:bg-primary dark:checked:border-primary" />
                                                    <span class="text-xs text-slate-500 dark:text-slate-400">Show outliers</span>
                                                </div>
                                            </div>
                                            <div class="sm:col-span-2">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-width">Box width</label>
                                                <input id="boxplot-width" name="boxplot_width" type="text" value="0.5"
                                                    class="mt-2 block w-full rounded-md border-0 py-1.5 text-xs text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary" />
                                            </div>
                                            <div class="sm:col-span-2">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-linewidth">Line width</label>
                                                <input id="boxplot-linewidth" name="boxplot_linewidth" type="text" value="0.5"
                                                    class="mt-2 block w-full rounded-md border-0 py-1.5 text-xs text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary" />
                                            </div>
                                            <div class="sm:col-span-2">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-median-color">Median color</label>
                                                <input id="boxplot-median-color" name="boxplot_median_color" type="text" value="red"
                                                    class="mt-2 block w-full rounded-md border-0 py-1.5 text-xs text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary" />
                                            </div>
                                            <div class="sm:col-span-2">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-median-width">Median width</label>
                                                <input id="boxplot-median-width" name="boxplot_median_linewidth" type="text" value="0.8"
                                                    class="mt-2 block w-full rounded-md border-0 py-1.5 text-xs text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary" />
                                            </div>
                                            <div class="sm:col-span-2">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-boxedge-width">Box edge width</label>
                                                <input id="boxplot-boxedge-width" name="boxplot_box_edge_width" type="text" value="0.2"
                                                    class="mt-2 block w-full rounded-md border-0 py-1.5 text-xs text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary" />
                                            </div>
                                            <div class="sm:col-span-2">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-facecolor">Box facecolor</label>
                                                <input id="boxplot-facecolor" name="boxplot_facecolor" type="text" value="none"
                                                    class="mt-2 block w-full rounded-md border-0 py-1.5 text-xs text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary" />
                                            </div>
                                            <div class="sm:col-span-2">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-colormap">Colormap</label>
                                                <input id="boxplot-colormap" name="boxplot_colormap" type="text" value="viridis"
                                                    class="mt-2 block w-full rounded-md border-0 py-1.5 text-xs text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary" />
                                            </div>
                                            <div class="sm:col-span-2">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-coloralpha">Colormap alpha</label>
                                                <input id="boxplot-coloralpha" name="boxplot_color_alpha" type="text" value="0.35"
                                                    class="mt-2 block w-full rounded-md border-0 py-1.5 text-xs text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary" />
                                            </div>
                                            <div class="sm:col-span-3">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-show-cohend">Cohen's d</label>
                                                <div class="mt-2 flex items-center gap-2">
                                                    <input id="boxplot-show-cohend" name="boxplot_show_cohend" type="checkbox"
                                                        x-model="boxplotShowCohen"
                                                        class="h-4 w-4 rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary dark:checked:bg-primary dark:checked:border-primary" />
                                                    <span class="text-xs text-slate-500 dark:text-slate-400">Show effect size vs control</span>
                                                </div>
                                            </div>
                                            <div class="sm:col-span-3" x-show="boxplotShowCohen" x-cloak>
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="boxplot-control-group">Control group</label>
                                                <select
                                                    class="mt-2 block w-full rounded-md border-0 py-1.5 text-xs text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary"
                                                    id="boxplot-control-group" name="boxplot_control_group" x-model="boxplotControlGroup"
                                                    :disabled="boxplotGroupValuesLoading || !boxplotGroupValues.length">
                                                    <option value="" disabled selected>Select a group</option>
                                                    <template x-for="val in boxplotGroupValues" :key="val">
                                                        <option :value="val" x-text="val"></option>
                                                    </template>
                                                </select>
                                                <p x-show="boxplotGroupValuesLoading" class="mt-1 text-[11px] text-slate-500 dark:text-slate-400">Loading group values...</p>
                                                <p x-show="boxplotGroupValuesError" class="mt-1 text-[11px] text-red-600 dark:text-red-400" x-text="boxplotGroupValuesError"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 flex flex-wrap items-center gap-3">
                                <button type="submit"
                                    formaction="{{ url_for('analysis_plot_boxplot') }}"
                                    data-plot-action="boxplot"
                                    class="flex items-center justify-center gap-2 h-11 px-5 rounded-lg bg-primary text-white text-sm font-semibold hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors"
                                    :disabled="!dfColumns.length || columnsLoading || !boxplotGroupBy || !boxplotValueCol || (boxplotShowCohen && !boxplotControlGroup)">
                                    Plot boxplot
                                </button>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Topomap configuration -->
                <div class="mt-12 space-y-8" x-show="activeTab === 'topomap'" x-cloak>
                    <section
                        class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                        <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Brain topographic plot</h2>
                        <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Select how data should be grouped for the topomap and configure plotting parameters.</p>
                        <div class="mt-6 border-t border-slate-200 dark:border-slate-700 pt-6">
                            <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                                <div class="sm:col-span-6">
                                    <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-300">Grouping mode</label>
                                    <div class="mt-3 space-y-3">
                                        <div class="relative flex items-start">
                                            <div class="flex h-6 items-center">
                                                <input
                                                    class="h-4 w-4 rounded-full border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-primary focus:ring-primary dark:checked:bg-primary dark:checked:border-primary"
                                                    id="topomap-mode-sensor" name="topomap_grouping_mode" type="radio" value="per_sensor"
                                                    x-model="topomapMode" />
                                            </div>
                                            <div class="ml-3 text-sm leading-6">
                                                <label class="font-medium text-slate-900 dark:text-slate-300" for="topomap-mode-sensor">Grouped by column at each sensor</label>
                                                <p class="text-slate-500 dark:text-slate-400">Plot a separate topomap per group in the selected column.</p>
                                            </div>
                                        </div>
                                        <div class="relative flex items-start">
                                            <div class="flex h-6 items-center">
                                                <input
                                                    class="h-4 w-4 rounded-full border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-primary focus:ring-primary dark:checked:bg-primary dark:checked:border-primary"
                                                    id="topomap-mode-compare" name="topomap_grouping_mode" type="radio" value="compare_categories"
                                                    x-model="topomapMode" />
                                            </div>
                                            <div class="ml-3 text-sm leading-6">
                                                <label class="font-medium text-slate-900 dark:text-slate-300" for="topomap-mode-compare">Compare categories within a column</label>
                                                <p class="text-slate-500 dark:text-slate-400">Compute group comparisons across categories in the selected column.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="sm:col-span-6" x-show="topomapMode === 'compare_categories'" x-cloak>
                                    <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-300">Comparison method</label>
                                    <div class="mt-3 space-y-3">
                                        <div class="relative flex items-start">
                                            <div class="flex h-6 items-center">
                                                <input
                                                    class="h-4 w-4 rounded-full border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-primary focus:ring-primary dark:checked:bg-primary dark:checked:border-primary"
                                                    id="topomap-compare-raw" name="topomap_compare_method" type="radio" value="raw"
                                                    checked />
                                            </div>
                                            <div class="ml-3 text-sm leading-6">
                                                <label class="font-medium text-slate-900 dark:text-slate-300" for="topomap-compare-raw">Subtract raw values</label>
                                                <p class="text-slate-500 dark:text-slate-400">Compute group mean differences vs the control group.</p>
                                            </div>
                                        </div>
                                        <div class="relative flex items-start">
                                            <div class="flex h-6 items-center">
                                                <input
                                                    class="h-4 w-4 rounded-full border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-primary focus:ring-primary dark:checked:bg-primary dark:checked:border-primary"
                                                    id="topomap-compare-cohen" name="topomap_compare_method" type="radio" value="cohen_d" />
                                            </div>
                                            <div class="ml-3 text-sm leading-6">
                                                <label class="font-medium text-slate-900 dark:text-slate-300" for="topomap-compare-cohen">Cohen's d</label>
                                                <p class="text-slate-500 dark:text-slate-400">Plot Cohen's d effect sizes vs the control group.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="sm:col-span-3">
                                    <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-300"
                                        for="topomap-group-by">Grouping column</label>
                                    <div class="mt-2">
                                        <select
                                            class="block w-full rounded-md border-0 py-1.5 text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm sm:leading-6"
                                            id="topomap-group-by" name="topomap_group_by" x-model="topomapGroupBy"
                                            x-effect="fetchGroupValues(topomapGroupBy, 'topomap')"
                                            :disabled="!dfColumns.length || columnsLoading">
                                            <option value="" disabled selected>Select a column</option>
                                            <template x-for="col in dfColumns" :key="col">
                                                <option :value="col" x-text="col"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <p x-show="columnsLoading" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Loading columns...</p>
                                    <p x-show="!columnsLoading && !dfColumns.length" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Upload a dataframe to enable column selection.</p>
                                </div>
                                <div class="sm:col-span-3" x-show="topomapMode === 'compare_categories'" x-cloak>
                                    <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-300"
                                        for="topomap-control-group">Control group</label>
                                    <div class="mt-2">
                                        <select
                                            class="block w-full rounded-md border-0 py-1.5 text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm sm:leading-6"
                                            id="topomap-control-group" name="topomap_control_group" x-model="topomapControlGroup"
                                            :disabled="topomapGroupValuesLoading || !topomapGroupValues.length">
                                            <option value="" disabled selected>Select a group</option>
                                            <template x-for="val in topomapGroupValues" :key="val">
                                                <option :value="val" x-text="val"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <p x-show="topomapGroupValuesLoading" class="mt-1 text-xs text-slate-500 dark:text-slate-400">Loading group values...</p>
                                    <p x-show="topomapGroupValuesError" class="mt-1 text-xs text-red-600 dark:text-red-400" x-text="topomapGroupValuesError"></p>
                                </div>
                                <div class="sm:col-span-3">
                                    <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-300"
                                        for="topomap-value-col">Column to plot</label>
                                    <div class="mt-2">
                                        <select
                                            class="block w-full rounded-md border-0 py-1.5 text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm sm:leading-6"
                                            id="topomap-value-col" name="topomap_value_col" x-model="topomapValueCol"
                                            :disabled="!dfColumns.length || columnsLoading">
                                            <option value="" disabled selected>Select a column</option>
                                            <template x-for="col in dfColumns" :key="col">
                                                <option :value="col" x-text="col"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <p x-show="columnsLoading" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Loading columns...</p>
                                    <p x-show="!columnsLoading && !dfColumns.length" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Upload a dataframe to enable column selection.</p>
                                </div>

                                <div class="sm:col-span-3">
                                    <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-300"
                                        for="head-radius">Radius of the head circumference</label>
                                    <div class="mt-2">
                                        <input
                                            class="block w-full rounded-md border-0 py-1.5 text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm sm:leading-6"
                                            id="head-radius" name="head-radius" type="text" value="0.095" />
                                    </div>
                                </div>
                                <div class="sm:col-span-3">
                                    <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-300"
                                        for="head-pos-x">Position of the head on the x-axis</label>
                                    <div class="mt-2">
                                        <input
                                            class="block w-full rounded-md border-0 py-1.5 text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm sm:leading-6"
                                            id="head-pos-x" name="head-pos-x" type="text" value="0.0" />
                                    </div>
                                </div>
                                <div class="sm:col-span-3">
                                    <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-300"
                                        for="electrode-size">Size of the electrodes</label>
                                    <div class="mt-2">
                                        <input
                                            class="block w-full rounded-md border-0 py-1.5 text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm sm:leading-6"
                                            id="electrode-size" name="electrode-size" type="text" value="0.6" />
                                    </div>
                                </div>
                                <div class="sm:col-span-6">
                                    <div class="mt-2 rounded-lg border border-slate-200 dark:border-slate-700 p-4">
                                        <h4 class="text-sm font-semibold text-slate-900 dark:text-slate-200">Colorbar options</h4>
                                        <div class="mt-3 grid grid-cols-1 gap-x-6 gap-y-4 sm:grid-cols-6">
                                            <div class="sm:col-span-3">
                                                <div class="flex items-center gap-2">
                                                    <input checked=""
                                                        class="h-4 w-4 rounded border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-primary focus:ring-primary dark:checked:bg-primary dark:checked:border-primary"
                                                        id="show-colorbar" name="show-colorbar" type="checkbox" value="true" />
                                                    <label class="text-sm font-medium text-slate-900 dark:text-slate-300"
                                                        for="show-colorbar">Show the colorbar label</label>
                                                </div>
                                            </div>
                                            <div class="sm:col-span-3">
                                                <label class="block text-xs font-medium text-slate-700 dark:text-slate-300"
                                                    for="topomap-scale-mode">Scale mode</label>
                                                <select
                                                    class="mt-2 block w-full rounded-md border-0 py-1.5 text-xs text-slate-900 dark:text-slate-300 dark:bg-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-700 focus:ring-2 focus:ring-inset focus:ring-primary"
                                                    id="topomap-scale-mode" name="topomap_scale_mode">
                                                    <option value="section" selected>Same scale per column index</option>
                                                    <option value="plot">Independent scale per plot</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 flex flex-wrap items-center gap-3">
                                <button type="submit"
                                    formaction="{{ url_for('analysis_plot_topomap') }}"
                                    data-plot-action="topomap"
                                    class="flex items-center justify-center gap-2 h-11 px-5 rounded-lg bg-primary text-white text-sm font-semibold hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors"
                                    :disabled="!dfColumns.length || columnsLoading || !topomapGroupBy || !topomapValueCol || (topomapMode === 'compare_categories' && !topomapControlGroup)">
                                    Plot topomap
                                </button>
                            </div>
                        </div>
                    </section>
                </div>
            </div>



            <!-- Navigation Buttons -->
            <div class="mt-10 flex flex-col sm:flex-row justify-between items-center gap-4">
                <!-- Previous/Return Button -->
                <template x-if="activeTab === 'upload-data'">
                    <a href="{{ url_for('dashboard') }}"
                        class="flex items-center justify-center gap-2 h-12 px-6 w-full sm:w-auto text-primary dark:text-white font-bold text-base rounded-lg hover:bg-primary/10 dark:hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors border border-primary dark:border-white/50">
                        <span class="material-symbols-outlined">arrow_back</span>
                        Return to ncpi dashboard
                    </a>
                </template>

                <template x-if="activeTab !== 'upload-data'">
                    <button type="button" @click="prevTab()"
                        class="flex items-center justify-center gap-2 h-12 px-6 w-full sm:w-auto text-primary dark:text-white font-bold text-base rounded-lg hover:bg-primary/10 dark:hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors border border-primary dark:border-white/50">
                        <span class="material-symbols-outlined">arrow_back</span>
                        Back step
                    </button>
                </template>

                <template x-if="activeTab === 'upload-data'">
                    <button type="button" @click="nextTab()"
                        class="flex items-center justify-center gap-2 h-12 px-6 w-full sm:w-auto bg-primary text-white font-bold text-base rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary/50 dark:focus:ring-offset-background-dark transition-colors">
                        Next step
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </button>
                </template>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Menu tab navigation -->
<script defer="" src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<!-- Handle of file uploads script -->
<script defer src="{{ url_for('static', filename='js/handleFileUpload.js') }}"></script>
<script defer>
    (function() {
        const overlay = document.createElement('div');
        overlay.id = 'plot-wait-overlay';
        overlay.className = 'fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/60 px-6';
        overlay.innerHTML = `
            <div class="w-full max-w-md rounded-xl bg-white p-6 text-center shadow-xl dark:bg-slate-900">
                <div class="mx-auto h-12 w-12 rounded-full border-4 border-slate-300 border-t-slate-600 dark:border-slate-700 dark:border-t-slate-300 animate-spin"></div>
                <div class="mt-4 text-sm font-semibold text-slate-900 dark:text-slate-100">Rendering plot...</div>
                <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">This can take a moment for large datasets.</div>
            </div>
        `;
        document.body.appendChild(overlay);

        const form = document.querySelector('form[enctype="multipart/form-data"]');
        if (!form) return;

        form.addEventListener('submit', async (event) => {
            const submitter = event.submitter;
            if (!submitter || !submitter.dataset.plotAction) {
                return;
            }
            event.preventDefault();
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            submitter.disabled = true;

            try {
                const formData = new FormData(form);
                const response = await fetch(submitter.getAttribute('formaction'), {
                    method: 'POST',
                    body: formData,
                });
                const html = await response.text();
                document.open();
                document.write(html);
                document.close();
            } catch (err) {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                submitter.disabled = false;
                alert('Failed to render plot. Please try again.');
            }
        });
    })();
</script>
{% endblock %}
