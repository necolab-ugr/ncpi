{% extends "base.html" %}
{% block title %}Inference{% endblock %}

<!-- Main color for simulation page: green -->
{% block head %}
{{ super() }}
<script id="tailwind-config">
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#39E079",
                    "background-light": "#f6f6f8",
                    "background-dark": "#101322",
                },
                fontFamily: {
                    "display": ["Space Grotesk"]
                },
                borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
            },
        },
    }
</script>
<style>
    body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" x-data="{ 
    uploads: {},
    isUploaded(id) { return this.uploads[id] !== undefined; },
    getFileName(id) { return this.uploads[id]?.name || ''; },
    }">
    <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white">Inference Module Configuration</h1>
    <p class="mt-2 text-slate-600 dark:text-slate-400">Set up your model, parameters, and actions for the inference process.</p>

    <!-- Form action -->
    <form action="{{ url_for('start_computation_redirect', computation_type='inference')}} " method="POST" enctype="multipart/form-data">  
        <div class="mt-12 space-y-8">
            <section
                class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Machine Learning
                        model</label>
                    <fieldset class="mt-2">
                        <legend class="sr-only">Machine Learning model</legend>
                        <div class="flex flex-wrap gap-4 items-center">
                            <!-- Hidden field that will always be sent -->
                            <input type="hidden" id="hidden-model-input" name="model" value="npe" />
                            <div class="flex items-center">
                                <input value="npe"
                                    class="h-4 w-4 border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
                                    id="model-npe" name="model-radio" type="radio" />
                                <label class="ml-2 block text-sm text-slate-900 dark:text-slate-200"
                                    for="model-npe">NPE</label>
                            </div>
                            <div class="flex items-center">
                                <input value="nle"
                                    class="h-4 w-4 border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
                                    id="model-nle" name="model-radio" type="radio" />
                                <label class="ml-2 block text-sm text-slate-900 dark:text-slate-200"
                                    for="model-nle">NLE</label>
                            </div>
                            <div class="flex items-center">
                                <input value="nre"
                                    class="h-4 w-4 border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
                                    id="model-nre" name="model-radio" type="radio" />
                                <label class="ml-2 block text-sm text-slate-900 dark:text-slate-200"
                                    for="model-nre">NRE</label>
                            </div>
                            <div class="flex items-center">
                                <input checked="" value="sklearn"
                                    class="h-4 w-4 border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
                                    id="model-sklearn" name="model-radio" type="radio" />
                                <label class="ml-2 block text-sm text-slate-900 dark:text-slate-200"
                                    for="model-sklearn">Custom sklearn model</label>
                            </div>
                            <div class="flex-grow sm:flex-grow-0 sm:ml-2">
                                <select
                                    class="block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 opacity-50 cursor-not-allowed"
                                    id="sklearn-dropdown" name="model-dropdown">
                                    <option value="MLPRegressor" selected="">Multi-Layer Perceptron (MLP)</option>
                                    <option value="LinearRegression">Linear Regression</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>
                </div>
            </section>
            <section
                class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                <h3 class="text-md font-semibold text-slate-900 dark:text-white">Add simulation data (optional)</h3>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Add simulation features and
                    parameters to the training data.</p>
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                for="features_sim">features (sim_X.pkl)</label>
                            <input @change="handleFileUpload($event)"
                                class="hidden"
                                id="features_sim" name="features_sim" type="file" accept=".pickle,.pkl" />
                            <button type="button" @click="document.getElementById('features_sim').click()"
                                class="block w-full rounded-md border border-slate-300 dark:border-slate-600 py-3 px-4 pr-10 text-left focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="material-icons text-slate-400">folder_open</span>
                                        <span class="text-slate-700 dark:text-slate-300 text-sm">
                                            Choose file...
                                        </span>
                                    </div>
                                    <span class="text-xs text-slate-500">Browse</span>
                                </div>
                            </button>
                            <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Load file with the format
                                .pickle or .pkl</p>
                        </div>
                        <!-- Upload status indicator -->
                        <div x-show="isUploaded('features_sim')" class="mt-4 p-3 bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 text-sm font-medium rounded-lg flex items-center gap-2">
                            <span class="material-symbols-outlined">check_circle</span>
                            <span>Data uploaded successfully</span>
                            <span x-show="getFileName('features_sim')" class="font-semibold">(<span x-text="getFileName('features_sim')"></span>)</span>
                        </div>
                    </div>
                    <div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                for="parameters">parameters (sim_theta.pkl)</label>
                            <input @change="handleFileUpload($event)"
                                class="hidden"
                                id="parameters" name="parameters" type="file" accept=".pickle,.pkl" />
                            <button type="button" @click="document.getElementById('parameters').click()"
                                class="block w-full rounded-md border border-slate-300 dark:border-slate-600 py-3 px-4 pr-10 text-left focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="material-icons text-slate-400">folder_open</span>
                                        <span class="text-slate-700 dark:text-slate-300 text-sm">
                                            Choose file...
                                        </span>
                                    </div>
                                    <span class="text-xs text-slate-500">Browse</span>
                                </div>
                            </button>
                            <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Load file with the format
                                .pickle or .pkl</p>
                        </div>
                        <!-- Upload status indicator -->
                        <div x-show="isUploaded('parameters')" class="mt-4 p-3 bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 text-sm font-medium rounded-lg flex items-center gap-2">
                            <span class="material-symbols-outlined">check_circle</span>
                            <span>Data uploaded successfully</span>
                            <span x-show="getFileName('parameters')" class="font-semibold">(<span x-text="getFileName('parameters')"></span>)</span>
                        </div>
                    </div>
                </div>
            </section>
            <section
                class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                <h3 class="text-md font-semibold text-slate-900 dark:text-white">Train (optional)</h3>
                <fieldset class="mt-4">
                    <legend class="sr-only">Training Options</legend>
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center">
                            <input 
                                class="h-4 w-4 border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
                                id="train-model" name="train-option" type="radio" value="train" />
                            <label class="ml-2 block text-sm text-slate-900 dark:text-slate-200" for="train-model">Train
                                model</label>
                        </div>
                        <div class="flex items-center">
                            <input checked="" class="h-4 w-4 border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
                                id="load-model" name="train-option" type="radio" value="load" />
                            <label class="ml-2 block text-sm text-slate-900 dark:text-slate-200" for="load-model">Load
                                pre-trained model</label>
                        </div>
                    </div>
                </fieldset>
                <div id="train-options" class="mt-6 space-y-6 ">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                for="kfold-splits">Number of splits for RepeatedKFold cross-validation</label>
                            <input
                                class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800"
                                id="kfold-splits" name="kfold-splits" type="text" value="10" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                for="kfold-repeats">Number of repeats for RepeatedKFold cross-validation</label>
                            <input
                                class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800"
                                id="kfold-repeats" name="kfold-repeats" type="text" value="10" />
                        </div>
                    </div>
                    <div class="pt-6 border-t border-slate-200 dark:border-slate-700">
                        <h4 class="text-sm font-semibold text-slate-900 dark:text-white">Training parameters for
                            SBI models</h4>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                    for="learning-rate">Learning rate</label>
                                <input
                                    class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800"
                                    id="learning-rate" name="learning-rate" type="text" value="0.005" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                    for="batch-size">Training batch size</label>
                                <input
                                    class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800"
                                    id="batch-size" name="batch-size" type="text" value="256" />
                            </div>
                        </div>
                    </div>
                </div>

                <div id="load-options" class="mt-6 space-y-6 hidden">
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                    for="model-file">Model</label>
                                <input @change="handleFileUpload($event)"
                                    class="hidden"
                                    id="model-file" name="model-file" type="file" accept=".pickle,.pkl" />
                                <button type="button" @click="document.getElementById('model-file').click()"
                                    class="block w-full rounded-md border border-slate-300 dark:border-slate-600 py-3 px-4 pr-10 text-left focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <span class="material-icons text-slate-400">folder_open</span>
                                            <span class="text-slate-700 dark:text-slate-300 text-sm">
                                                Choose file...
                                            </span>
                                        </div>
                                        <span class="text-xs text-slate-500">Browse</span>
                                    </div>
                                </button>
                                <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Load file with the format
                                    .pickle or .pkl</p>
                            </div>
                            <!-- Upload status indicator -->
                            <div x-show="isUploaded('model-file')" class="mt-4 p-3 bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 text-sm font-medium rounded-lg flex items-center gap-2">
                                <span class="material-symbols-outlined">check_circle</span>
                                <span>Data uploaded successfully</span>
                                <span x-show="getFileName('model-file')" class="font-semibold">(<span x-text="getFileName('model-file')"></span>)</span>
                            </div>
                        </div>
                        <div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                    for="scaler-file">Scaler</label>
                                <input @change="handleFileUpload($event)"
                                    class="hidden"
                                    id="scaler-file" name="scaler-file" type="file" accept=".pickle,.pkl" />
                                <button type="button" @click="document.getElementById('scaler-file').click()"
                                    class="block w-full rounded-md border border-slate-300 dark:border-slate-600 py-3 px-4 pr-10 text-left focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <span class="material-icons text-slate-400">folder_open</span>
                                            <span class="text-slate-700 dark:text-slate-300 text-sm">
                                                Choose file...
                                            </span>
                                        </div>
                                        <span class="text-xs text-slate-500">Browse</span>
                                    </div>
                                </button>
                                <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">IMPORTANT. Load file with the format
                                    .pickle or .pkl</p>
                            </div>
                            <!-- Upload status indicator -->
                            <div x-show="isUploaded('scaler-file')" class="mt-4 p-3 bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 text-sm font-medium rounded-lg flex items-center gap-2">
                                <span class="material-symbols-outlined">check_circle</span>
                                <span>Data uploaded successfully</span>
                                <span x-show="getFileName('scaler-file')" class="font-semibold">(<span x-text="getFileName('scaler-file')"></span>)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Hyperparameters section for training -->
                    <section
                        class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-md font-semibold text-slate-900 dark:text-white">Hyperparameters (optional)</h3>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="prior-dist">Prior
                                    distribution over parameters</label>
                                <input
                                    class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800"
                                    id="prior-dist" name="prior-dist" type="text" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                    for="density-estimator">Density estimator</label>
                                <input
                                    class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800"
                                    id="density-estimator" name="density-estimator" type="text" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300" for="nn-type">Neural
                                    network type model</label>
                                <input
                                    class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800"
                                    id="nn-type" name="nn-type" type="text" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                    for="hidden-units">Hidden units per layer</label>
                                <input
                                    class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800"
                                    id="hidden-units" name="hidden-units" type="text" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                                    for="flow-transforms">Number of normalizing flow transformations</label>
                                <input
                                    class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 shadow-sm focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800"
                                    id="flow-transforms" name="flow-transforms" type="text" />
                            </div>
                        </div>
                    </section>
                </div>
            </section>
            <section
                class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                <h3 class="text-md font-semibold text-slate-900 dark:text-white">Predict</h3>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Predict the parameters.</p>
                <div class="mt-6 space-y-2 gap-x-8 gap-y-6">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300"
                        for="features_predict">features</label>
                    <div class="mt-1 shadow-sm">
                        <input 
                            type="file" 
                            id="features_predict" 
                            name="features_predict"
                            class="hidden"
                            accept=".csv,.xlsx,.xls,.parquet,.feather,.pkl,.pickle"
                            @change="handleFileUpload($event)" />
                        <button type="button" @click="document.getElementById('features_predict').click()"
                            class="block w-1/2 rounded-md border border-slate-300 dark:border-slate-600 py-3 px-4 pr-10 text-left focus:border-primary focus:ring-primary sm:text-sm bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="material-icons text-slate-400">folder_open</span>
                                    <span class="text-slate-700 dark:text-slate-300 text-sm">
                                        Click to upload
                                    </span>
                                </div>
                                <span class="text-xs text-slate-500">Browse</span>
                            </div>
                        </button>
                    </div>
                    <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Upload a dataframe with the
                        features. CSV, Excel, Parquet, Feather or Pickle files</p>
                </div>
                <!-- Upload status indicator -->
                <div x-show="isUploaded('features_predict')" class="mt-4 p-3 bg-green-100 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 text-sm font-medium rounded-lg flex items-center gap-2">
                    <span class="material-symbols-outlined">check_circle</span>
                    <span>Data uploaded successfully</span>
                    <span x-show="getFileName('features_predict')" class="font-semibold">(<span x-text="getFileName('features_predict')"></span>)</span>
                </div>
            </section>

            <!-- Method selection -->
            <section class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                <h3 class="text-md font-semibold text-slate-900 dark:text-white">Method used to compute the uploaded features</h3>
                <div class="flex flex-wrap gap-4 items-center p-4">
                    <div class="flex items-center">
                        <input checked="" value="catch22"
                            class="h-4 w-4 border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
                            id="catch22" name="method" type="radio" />
                        <label class="ml-2 block text-sm text-slate-900 dark:text-slate-200"
                            for="catch22">Catch22</label>
                    </div>
                    <div class="flex items-center">
                        <input value="power_spectrum_parameterization_1"
                            class="h-4 w-4 border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
                            id="power_spectrum_parameterization_1" name="method" type="radio" />
                        <label class="ml-2 block text-sm text-slate-900 dark:text-slate-200"
                            for="power_spectrum_parameterization_1">Power spectrum parameterization</label>
                    </div>
                </div>
            </section>
            <!-- Example selection -->
            <section class="bg-white dark:bg-slate-800/50 rounded-lg p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                <h3 class="text-md font-semibold text-slate-900 dark:text-white">Example processing</h3>
                <div class="flex flex-wrap gap-4 items-center p-4">
                    <div class="flex items-center">
                        <input checked="" value="lfp"
                            class="h-4 w-4 border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
                            id="lfp" name="example" type="radio" />
                        <label class="ml-2 block text-sm text-slate-900 dark:text-slate-200"
                            for="lfp">LFP</label>
                    </div>
                    <div class="flex items-center">
                        <input value="eeg"
                            class="h-4 w-4 border-slate-300 dark:border-slate-600 text-primary focus:ring-primary"
                            id="eeg" name="example" type="radio" />
                        <label class="ml-2 block text-sm text-slate-900 dark:text-slate-200"
                            for="eeg">EEG</label>
                    </div>
                </div>
            </section>
        </div>
        <div class="mt-16 flex justify-end items-center space-x-4 pb-20 lg:pb-0">
            <a href="{{ url_for('dashboard') }}"
                class="px-6 py-3 border border-transparent text-base font-medium rounded-md text-slate-700 dark:text-slate-300 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500"
                type="button">Back to the dashboard</a>
            <button
                class="px-6 py-3 border border-slate-300 dark:border-slate-600 text-base font-medium rounded-md text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
                type="button">Save trained model</button>
            <button
                class="px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
                type="submit">Compute predictions</button>
        </div>
    </form>  
</div>

{% endblock %}
{% block scripts %}
<!-- Alpine -->
<script defer="" src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="{{ url_for('static', filename='js/inference.js') }}"></script>
<!-- Handle of file uploads script -->
<script defer src="{{ url_for('static', filename='js/handleFileUpload.js') }}"></script>
{% endblock %}